<html>
   <head>
      <!-- Load WebAssembly module -->
      <script type="text/javascript" src="loki_bindings.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/vega@5.13.0"></script>
    	<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.13.0"></script>
    	<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.8.0"></script>
   </head>
   <body>
			<div>
				<input type="file" id="file-input" accept=".json">
			</div>
			<div>
				<button type="button" id="run-button">Run</button>
			</div>
			<div id="plotting-area"></div>
      <div>
        Return value =
        <span id="answer"/>
      </div>
      <script>
				const file_input = document.getElementById("file-input");
				let file = "";

				const run_button = document.getElementById("run-button");
				
				let module;

				file_input.addEventListener("change", (event) => {
					const list = event.target.files;
					file = event.target.files[0];
				});
				function lxcat_get(input) {
					for (const [i, file] of input.electronKinetics.LXCatFiles.entries()) {
						if (file.substr(0, 5) == "http:") {
							const http = new XMLHttpRequest();
							http.open("GET", file, false);
							http.send(null);
							input.electronKinetics.LXCatFiles[i] = "/" + i + ".json"
							module.FS.writeFile("/" + i + ".json", http.responseText, { flags: "w+" });
						}
					}
				}
				run_button.addEventListener("click", (event) => {
        	// Wait for module to initialize,
        	create_module().then((_module) => {
						module = _module;
						try {
							file.text().then((contents) => {
								let input = JSON.parse(contents);
								lxcat_get(input);
					  		const ret = module.run(JSON.stringify(input));
        	   		document.getElementById("answer").innerHTML = ret;
							});
						} catch(e) {
							console.log(e/*.stack*/);
						}
        	});
				});
				function plot(x_ptr, x_size, y_ptr, y_size) {
					// Map sections of the emscripten heap onto contiguous arrays of doubles.
					const x_arr = new Float64Array(module.HEAPF64.buffer, x_ptr, x_size);
					const y_arr = new Float64Array(module.HEAPF64.buffer, y_ptr, y_size);
					const data = new Array(x_size).fill().map((_, index) => {return {x: x_arr[index], y: y_arr[index]}});
					const spec = {
        	  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
        	  "width": 800,
        	  "height": 600,
        	  "data": {
        	    "values": data
        	  },
        	  "encoding": {
        	    "x": {"field": "x", "type": "quantitative", "title": "Energy (eV)"},
							"y": {"field": "y", "type": "quantitative", "scale": {"type": "log"}, "title": "Eedf"}
        	  },
        	  "mark": {
        	    "type": "circle",
        	    // Enable tooltip so on mouseover it shows all data of that iteration
        	    "tooltip": {"content": "data"}
        	  },
        	  // Enable zooming and panning
        	  "selection": {"grid": {"type": "interval", "bind": "scales"}}
        	};
					vegaEmbed(document.getElementById("plotting-area"), spec);
				}
      </script>
   </body>
</html>
