\documentclass{book}

\usepackage{framed}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{siunitx}
% the next block is the modern way of achieving 'a4wide'
\usepackage{geometry}
\usepackage{layout}
\geometry{
  includeheadfoot,
  margin=2.54cm
}
\usepackage{xfrac}
\newcommand{\frachalf}{\ensuremath{\sfrac{1}{2}}}
\newcommand{\phalf}[1]{\ensuremath{{#1}+\frachalf}}
\newcommand{\mhalf}[1]{\ensuremath{{#1}-\frachalf}}
\newcommand{\pmhalf}[1]{\ensuremath{{#1}\pm\frachalf}}

\newcommand{\MEAN}[1]{\ensuremath{\left\langle{{#1}}\right\rangle}}

\input{../../doc/listings}
\input{../../doc/loki_defs}

% boldface matrix and vector
\newcommand{\bmat}[1]{{\ensuremath{\bm {#1}}}}
\newcommand{\bvec}[1]{{\ensuremath{\bm {#1}}}}
% diag - make a diagonal matrix from a vector.
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\sgn}{sgn}


\bibliographystyle{unsrt}

\title{Notes on the C++ Implementation of LoKI-B}
\author{Jan van Dijk, Daan Boer and Wouter Graef}

\begin{document}

\maketitle

\chapter*{Preface}

This document contains notes about the C++ version of LoKI-B.
It provides additional details of definitions and algorithms that are not
explicitly written in the LoKI-B paper \cite{Tejero2019} or the User Manual
of the initial public release of LoKI-B \cite{Manual_1_0_0}. It also
discusses features of the C++ version that are not available yet in the MATLAB
version, such as support for JSON input files and the Web deployment of LoKI-B
and discusses and motivates things that have been done different in the C++
version for various reasons.

\tableofcontents

\chapter{Basic Equations}

\section{Basic Quantities}

There are multiple variables that describe the densities (absolute and relative)
of the gases and states.
\begin{itemize}
  \item $N$
  \item $N_k$
  \item Gas fraction:
  \begin{equation}
    \chi_k = N_k/N.
    \label{eq:chi_k}
  \end{equation}
  \item $\xi_{k_i}$
  \item $\delta_{k_i}$
\end{itemize}

\begin{itemize}
  \item In the Loki-B paper \cite{Tejero2019}, in the text between equations 1
  and 2, $\xi_{k_i}$ is defined as the density of a state $k_i$ divided by that
  of the sum of all densities of states of gas $k$. On the other hand, in the
  LoKI-B user manual (version 1.0.0) \cite{Manual_1_0_0} below equation 2 it
  is defined as the density of that state divided by its parent density.
  TODO: what is in MATLAB? Let's adopt that and state that clearly here.
  \item The name \SRC{density} that appeared in the code corresponded to the
  `reduced density' $\delta_{k}$ in the user guide. In the C++ code this is
  now provided by member \SRC{delta()} of the state class.
\end{itemize}


\section{Notation of the EEDF, Equation Compatibility with LoKI-B and BOLSIG+}

\label{sec:compatibility}

\begin{framed}
Some notes beforehand, that will explain differences between what you find
in the LoKI-B documents, the BOLSIG+ paper and the present document.
\begin{itemize}
	\item We use a superscript instead of a subscript to indicate the isotropic
		and first anisotropic contributions.
	\item We use $F$ for distribution functions that are normalized to the
		electron density field, and will use $f$ later on to refer to
		normalized distribution functions. This is the same as in LoKI-B,
		BOLSIG+ does it the other way around.
	\item The angle $\theta$ is defined to be the angle with the positive
		$z$-axis in this document. Also the electric field is supposed
		to be aligned with this axis, so $\vec{E}(t)=E_z(t)\vec{e}_z$,
		and since there is only one component, $E := E_z$ is used.
		This is the convention that is also used in \cite{Hagelaar2005}:
		see the discussion between equations 3 and 4 of that paper.

		In LoKI-B, the electric field component is defined with an explicit
		minus sign (see e.g. \cite[eq. 1]{Manual_2_2_0}), which states
		$\vec{E}(t)=-E_p\cos(\omega t)\vec{e}_z$, where $E_p$ is the number
		that is specified in the input file (which may also contain a factor
		$1/\sqrt{2}$ in case of HF fields). Then, $E_z(t)=-E_p\cos(\omega t)$.

		The symbol $E$ that is used in the LoKI code and manual is $E := -E_z$.
	\item Although the parameter $\epsilon$ (energy) is used in equations \cite[eq. 3--6]{Hagelaar2005},
		these equations describe the {\em velocity} representation of the
		distribution function, using spherical coordinates $(v,\theta,\phi)$.
		This means that the expected number of electrons in an infinitesimal
		coordinate box around $(v,\theta,\phi)$ is given by
		$F_v(v,\theta,\phi)v^2\sin\theta\dd{v}\dd{\theta}\dd{\phi}$.
		We make that clear by adding the subscript $v$.
	\item The mobility is defined to be the ratio $v_d/E$. This means that
		the mobility has the same sign as the drift velocity, and it
		is negative in the case of electrons. In other words: also here
		we do not `invent' explicit minus signs ourselves.
		Both LoKI-B and BOLSIG+ define $\mu_e=-v_d/E$ instead.
	\item The Townsend coefficient has been defined as
		$\alpha=(\dd{n_e}/\dd{z})/n_e$: also here we do not invent
		explicit minus signs. This means that $\alpha$ will be negative in case
		the growth happens in the negative $z$-direction (which normally
		corresponds to $E_z>0$).

		Also LoKI-B defines $\alpha$ this way, see \cite[eq. 52b]{Manual_2_2_0}.
		But note that $\alpha$ will be {\em positive} for positive $E$
		in LoKI-B, because of the definition that $E=-E_z$.

		In BOLSIG+, we see $\alpha=-(\dd{n_e}/\dd{z})/n_e$ instead (equation
		\cite[16]{Hagelaar2005}). Also the mean velocity $w$ (BOLSIG+ notation)
		is defined with a minus sign (same equation).
	\item In \cite[52a--b]{Manual_2_2_0} and in \cite[20b]{Tejero2019}, the mean
		velocity is called the mean {\em drift} velocity. That seems wrong, since
		the definition also includes the diffusion velocity in the case
		of spatial growth (eq. 52b). In this document the mean velocity
		is just called $\MEAN{v_z}$.
	\item	In BOLSIG+ and in LoKI-B, the energy is expressed in $eV$. BOLSIG+
		uses the symbol $\epsilon$ for energy, LoKI-B uses $u$. In this
		text we systematically use $\epsilon$ for an energy in $J$, and
		$u=\epsilon/e$ for an energy in $eV$.
	\item In LoKI-B, some additional factors $\gamma$ and $1/\gamma$ appear in
		the definitions of the terms of the Boltzmann equations, compared with
		BOLSIG+ and the present text. In the final form of the equation,
		the one that is actually discretized, all terms have an extra $1/\gamma$.
		As a result, the definition of the source $S(u)$ (LoKI-B) has this
		additional factor compared to the BOLSIG+ expression $\tilde{C}^0(u)$,
		and $S(u)=\tilde{C}^0(u)/\gamma$.
	\item In the manual \cite[eq. 48a-b]{Manual_2_2_0}, the definitions of $D_u$ and
		$\mu_u$ in equations 48a-b are different by a factor $\MEAN{u}$, compared
		to Hagelaar's definitions \cite[eq. 61,62]{Hagelaar2005}. See the note
		below equation \eqref{eq:muuN}. In the present text Hagelaar's definitions
		have been used.
\end{itemize}
What does this mean in practice? How can you translate the equations in the subsequent
sections into those found in LoKI-B \cite{Manual_2_2_0} BOLSIG+ \cite{Hagelaar2005}?
\begin{itemize}
	\item LoKI-B manual/paper: In all equations, change:
		\begin{itemize}
			\item $\mu_e\rightarrow -\mu_e$,
			\item $E\rightarrow -E$,
			\item $\MEAN{v_z}\rightarrow v_d$,
			\item $f \rightarrow f^{0}_u$: Unfortunately. there is no symbol
			in LoKI-B for the complete approximation of the distribution
			function, $f^0_u+f^1\cos\theta$, since $f$ is used for
			$f^0_u$, the first term of its expansion.
			I find this very confusing, since as a result for example
			$F(u)\neq n_ef(u)$, and hope it can be changed in the LoKI-docs
			and code. In the LoKI-B {\em code}, the name \SRC{eedf} is used
			for $f^0(u)$, which is confusing for the same reason.
			\item $\tilde{C}^0(u)\rightarrow \gamma S(e)$.
			\item Divide expressions for $D_\epsilon$ and $\mu_\epsilon$ by
				$\MEAN{u}$.
		\end{itemize}
	\item BOLSIG+ paper: In all equations, change:
		\begin{itemize}
			\item $\mu_e\rightarrow -\mu_e$,
			\item $E\rightarrow -E$,
			\item $\alpha\rightarrow -\alpha$,
			\item $\MEAN{v_z}\rightarrow -w$,
			\item $\epsilon\rightarrow u$,
			\item $F_{0,1} \rightarrow f^{0,1}_u$ and vice versa.
		\end{itemize}
\end{itemize}
\end{framed}

\section{The Two-Term Expansion of the Boltzmann Equation}

In the original LoKI-B paper \cite{Tejero2019}, the result of the two-term
expansion of the electron Boltzmann equation is not written; only the results
that are obtained using a temporal or a spatial growth model are written (see
equations 3a--b and equations 4a--b of that paper, respectively). Also in the
later paper about the time-dependent extension of LoKI-B \cite{Tejero2021},
only the result of applying the temporal growth model to the two-term
expansion of the EBE is provided (equations 3a--b of that paper).

In order to understand how the various simulation modes that are supported by
LoKI-B are special cases of the two-term expansion, it is easiest to start with
the full equations for the distribution function in the two-term approximation.
These can be found e.g. in the BOLSIG+ paper \cite[eq. 3--6]{Hagelaar2005},
but we adopt the notation as indicated in section \ref{sec:compatibility}.
With these changes, the distribution function is given by
\begin{equation}
	F_v(v,\theta,z,t) = F^0_v(v,z,t) + F^1_v(v,z,t)\cos\theta,
	\label{eq:Fv(Fv0,Fv1)}
\end{equation}
where $\theta$ is the angle with the electric field. This function is normalized by
the requirement that integration over velocity space yields the electron density,
resulting in
\begin{equation}
	\int\limits_0^{2\pi}\int\limits_0^\pi\int\limits_0^\infty F_v(v,\theta,z,t)v^2\sin\theta\dd{v}\dd{\theta}\dd{\phi}
	= 4\pi\int\limits_0^\infty F^0_v(v,z,t)v^2\dd{v}
	=n_e(z,t),
	\label{eq:Fv-norm-vel}
\end{equation}
since the $\theta$-integration of the term involving $F^1_v$ vanishes because of
the factor $\cos\theta$. Using energy $\epsilon$ as parameter instead of $v$, we
find, using $v=\sqrt{2\epsilon/m_e}$,
\begin{equation}
	\int\limits_0^{2\pi}\int\limits_0^\pi\int\limits_0^\infty F_v(v,\theta,z,t)v^2\sin\theta\dd{v}\dd{\theta}\dd{\phi}
	= 2\pi\left(\frac{2}{m_e}\right)^{3/2}\int\limits_0^\infty F^0_v(v(\epsilon),z,t)\sqrt{\epsilon}\dd{\epsilon}
	= \int\limits_0^\infty F^0_\epsilon(\epsilon,z,t)\sqrt{\epsilon}\dd{\epsilon},
	\label{eq:Fv-norm-eps}
\end{equation}
where we have {\em defined} the energy representation of the distribution function, which absorbs
the constant factor, but {\em not} the factor $\sqrt{\epsilon}$, as
\begin{equation}
	F^{0,1}_\epsilon(\epsilon,z,t)
	:=
	2\pi \left(\frac{2}{m}\right)^{3/2}F^{0,1}_v(v(\epsilon),z,t).
	\label{eq:F^{0,1}_eps(eps)}
\end{equation}
From the previous two expresssions it follows that the function has the integral property
\begin{equation}
	\int\limits_0^\infty F^0_\epsilon(\epsilon,z,t)\sqrt{\epsilon}\dd{\epsilon}=n_e(z,t).
	\label{eq:F0eps-norm}
\end{equation}

Along the same lines, if we insist on using $\si{eV}$ as energy unit instead of $J$, define
$u:=\epsilon/e$ as the energy in $eV$, and use $v=\sqrt{2eu/m}$, the energy-in-$\si{eV}$
representation results:
\begin{equation}
	F^{0,1}_u(u,z,t)
	:=
	2\pi \left(\frac{2e}{m}\right)^{3/2}F^{0,1}_v(v(u),z,t)
	= 2\pi\gamma^3F_v(v(u)),
	\label{eq:F^{0,1}_u(u)}
\end{equation}
where, following Hagelaar et al. \cite[below eq. 6]{Hagelaar2005}, we have
defined the constant $\gamma$ as
\begin{equation}
  \gamma = \sqrt{2e/m_e}.
  \label{eq:gamma}
\end{equation}
For completeness sake, the function $F^0_u(u,z,t)$ has the integral property
\begin{equation}
	\int\limits_0^\infty F^0_u(u,z,t)\sqrt{u}\dd{u}=n_e(z,t).
	\label{eq:F0u-norm}
\end{equation}
\begin{framed}
 \noindent Note that the only change from \eqref{eq:F^{0,1}_eps(eps)} to
  \eqref{eq:F^{0,1}_u(u)} is the appearance of $\gamma=\sqrt{2e/m_e}$ instead
  of $\sqrt{2/m_e}$.

  In fact, 90\% of the job of making LoKI-B SI-clean would be achieved by
  redefining $\gamma$ as $\sqrt{2/m_e}$. The rest of the work is to convert
  incoming numbers that are now expressed in $\si{eV}$ instead of in $\si{J}$
  or $K$, a hand full of miscellaneous conversions of constants that are
  used in the code (CAR, the electron-electron collision operator) and an
  occasional change $-1 \rightarrow q_e$ (e.g. in the calculation of Ohmic
  dissipation: $-\Gamma E \rightarrow q_e\Gamma E$ to convert $\si{eV/m^3/s}$ into
  $\si{W/m^3}$.
\end{framed}

The distribution functions $F^{0,1}_u(u,z,t)$ can be written as the product of the electron
density $n_e$ and normalized distribution functions $f^{0,1}_u(u,z,t)$,
\begin{equation}
	F^{0,1}_u(u,z,t)=n_e(z,t)f^{0,1}_u(u,z,t).
	\label{eq:F=n_ef}
\end{equation}
and from equation \eqref{eq:F0u-norm} it follows that
\begin{equation}
	\int\limits_0^\infty f^0_u(u,z,t)\sqrt{u}\dd{u}=1.
	\label{eq:f0u-norm}
\end{equation}

The average value of a function $g(u,\theta)$ is given by (TODO: derive)
\begin{align}
	\MEAN{g(u,\theta)}
	=
	2\pi\int\limits_0^\pi\int\limits_0^\infty g(u(v),\theta)f_v(v,\theta,z,t)v^2\sin\theta\dd{v}\dd{\theta}
	=
	\frac{1}{2}\int\limits_0^\pi\int\limits_0^\infty g(u,\theta)f_u(u,\theta,z,t)\sqrt{u}\sin\theta\dd{u}\dd{\theta}.
\end{align}
If $g$ is of the form $g_u(u)g_\theta(\theta)$, this becomes
\begin{align}
	\MEAN{g(u,\theta)}
	&=
	\frac{1}{2}\int\limits_0^\pi\int\limits_0^\infty g_u(u)g_\theta(\theta)
		\left(f^0_u(u,z,t) + f^1_u(u,z,t)\cos\theta\right)\sqrt{u}\sin\theta\dd{u}\dd{\theta}
	\nonumber \\
	&=
	\int\limits_0^\infty g_u(u)\sqrt{u}f^0_u(u,z,t)\dd{u}
		\frac{1}{2}\int\limits_0^\pi g_\theta(\theta)\sin\theta\dd{\theta}
	\nonumber \\
	&+
	\int\limits_0^\infty g_u(u)\sqrt{u}f^1_u(u,z,t)\dd{u}
		\frac{1}{2}\int\limits_0^\pi g_\theta(\theta)\cos\theta\sin\theta\dd{\theta}.
\end{align}
Some relevant special cases are:
\begin{align}
	\MEAN{g(u)}
		= \int\limits_0^\infty g_u(u)\sqrt{u}f^0_u(u,z,t)\dd{u}, \\
	\MEAN{g(u)\cos\theta}
		= \frac{1}{3}\int\limits_0^\infty g_u(u)\sqrt{u}f^1_u(u,z,t)\dd{u}.
\end{align}
In particular, we have the following expressions for the mean speed, the component of the
mean velocity along the electric field and the mean energy:
\begin{alignat}{2}
	\MEAN{v} &= \gamma\int\limits_0^\infty u f^0_u(u,z,t)\dd{u} && \quad\quad\mbox{mean electron speed ($v=\gamma \sqrt{u}$)} \label{eq:meanv} \\
	\MEAN{v_z} = \MEAN{v\cos\theta} &= \frac{\gamma}{3}\int\limits_0^\infty uf^1_u(u,z,t)\dd{u} && \quad\quad\mbox{mean velocity component $\parallel E$} \label{eq:meanvz} \\
	\MEAN{u} &= \int\limits_0^\infty u\sqrt{u} f^0_u(u,z,t)\dd{u} && \quad\quad\mbox{mean electron energy} \label{eq:meanu}
\end{alignat}
Using $F^{0,1}$ instead of $f^{0,1}$ or, equivalently, multiplying some of the previous results
with $n_e$, gives some important density and flux density expressions:
\begin{alignat}{2}
	n_u = n_e\MEAN{u} &= n_e\int\limits_0^\infty u\sqrt{u} f^0_u(u,z,t)\dd{u} && \quad\quad\mbox{mean electron energy density} \label{eq:n_u} \\
	\Gamma_e = n_e\MEAN{v_z} &= n_e\frac{\gamma}{3}\int\limits_0^\infty uf^1_u(u,z,t)\dd{u} && \quad\quad\mbox{electron flux density component $\parallel E$} \label{eq:Gamma_e} \\
	\Gamma_u = n_e\MEAN{uv_z} &= n_e\frac{\gamma}{3}\int\limits_0^\infty u^2f^1_u(u,z,t)\dd{u} && \quad\quad\mbox{electron energy flux density component $\parallel E$} \label{eq:Gamma_u}
\end{alignat}

Finally, let us see how we can integrate terms of the form $u^p\dd{(u^q F^{0,1})}/\dd{u}$
for $p\neq -1 \wedge p+q-1\geq 0$ over energy space --- we will need this. Partial integration yields
\begin{align}
	\int\limits_0^\infty u^p\PDEV{u^q F^{0,1}}{u}\dd{u}
	&=
	 \int\limits_0^\infty \PDEV{u^p(u^qF^{0,1})}{u}\dd{u}
	-\int\limits_0^\infty u^qF^{0,1}\PDEV{u^p}{u}\dd{u}
	\nonumber \\
	&=
	 \left[u^{p+q}F^{0,1}\right]_0^\infty
	-\int\limits_0^\infty pu^{p+q-1}F^{0,1}\dd{u}
	\nonumber \\
	&=
	-\int\limits_0^\infty pu^{p+q-1}F^{0,1}\dd{u}.
	\label{eq:upduqF/du-int}
\end{align}
Here we have used that fact that $u^{p+q}F^{0,1}(u)$ vanishes at $u=0$ for $p+q\geq 1$,
and goes to $0$ for $u\rightarrow\infty$. As an example,
$ (\gamma/3)\int_0^\infty u\dd{(uF^1)}/\dd{u}
 =
 -(\gamma/3)\int\limits_0^\infty uF^1\dd{u}=-\Gamma_e$
(here $p=1$, $q=1$).


\section{Equations for $F^0_u$ and $F^1_u$}

The equations that govern $F^{0,1}_v$ are given by \cite[eq. 3--6]{Hagelaar2005}.
With the notational changes that have been indicated in section \ref{sec:compatibility},
by taking $E$ outside of the $u$-differentation and after multiplication
with $\sqrt{u}$ these are
\begin{align}
	&\sqrt{u}\PDEV{F_v^0}{t}
	+ \frac{\gamma}{3}u\PDEV{F_v^1}{z}
	- \frac{\gamma}{3}E\PDEV{u F^1}{u}
	= \sqrt{u}C^0(u),
	\label{eq:ebe-2term-hagelaar-F-v0} \\
	&\sqrt{u}\PDEV{F_v^1}{t}
	+ \gamma u\PDEV{F_v^0}{z}
	- E\gamma u\PDEV{F_v^0}{u}
	= -N\sigma_m(u)\gamma u F_v^1(u).
	\label{eq:ebe-2term-hagelaar-F-v1}
\end{align}
Substitution of $F^{0,1}_v(v(u))$ from equation \eqref{eq:F^{0,1}_u(u)} in equations
\eqref{eq:ebe-2term-hagelaar-F-v0}--\eqref{eq:ebe-2term-hagelaar-F-v1} yields the equations
for the $u$-representations of the distribution functions,
\begin{align}
	&\sqrt{u}\PDEV{F^0_u}{t}
	+ \frac{\gamma}{3}u\PDEV{F^1_u}{z}
	- \frac{\gamma}{3}E\PDEV{u F^1_u}{u}
	= \tilde{C}^0(u)n_eN,
	\label{eq:ebe-2term-F-u0} \\
	&\sqrt{u}\PDEV{F^1_u}{t}
	+ \gamma u\PDEV{F^0_u}{z}
	- E\gamma u\PDEV{F^0_u}{u}
	= -N\sigma_m(u)\gamma uF^1_u(u).
	\label{eq:ebe-2term-F-u1}
\end{align}
Note that these equations are the same as the original ones, except for the term on the
right-hand side of the first equation. The new symbol $\tilde{C}^0$ is defined as
\cite[eq. 14]{Hagelaar2005}
\begin{equation}
	\tilde{C}^0=2\pi\gamma^3\sqrt{u}\frac{C_0}{Nn_e}.
	\label{eq:Ctilde0}
\end{equation}
The reason for this new symbol is that it $\tilde{C}^0$ does not depend on $n_e$ or
$N$, except for the case of electron-electron collisions, that will be discussed in section
\ref{sec:ee-operator}.

\begin{framed}
	{\bf Compatibility note:}
	in order to obtain the equations underlying LoKI-B, replace $E\rightarrow -E$
	in the remainder of this chapter, see section \ref{sec:compatibility}.
\end{framed}

Integrating equation \eqref{eq:ebe-2term-F-u0} over all energies and using equations
\eqref{eq:F0u-norm} and \eqref{eq:Gamma_e} yields
\begin{equation}
	\PDEV{n_e}{t} + \PDEV{\Gamma_e}{z} = S_e(z,t).
	\label{eq:particle-balance}
\end{equation}
This equation can be recognized as the particle balance equation for the
electrons, with the volumetric (net) particle production rate $S_e$ given by
\begin{equation}
	S_e(z,t)
	= n_eN\int\limits_0^\infty\tilde{C}^0(u)\dd{u}.
	\label{eq:S_e}
\end{equation}
This expression for $S_e$ will be justified later, in chapter \ref{ch:sources}.
Because we have argued that the source term is mostly linear in $n_e$ and $N$,
it makes
sense to define the net ionization frequency $\MEAN{\nu_{\mbox{eff}}}$ and the
effective rate coefficient $\MEAN{K_{\mbox{eff}}}$ such that
\begin{align}
	S_e(z,t) &= n_e(z,t)\MEAN{\nu_{\mbox{eff}}}(z,t), \label{eq:S_e(nu^eff)} \\
	S_e(z,t) &= n_e(z,t)N(z,t)\MEAN{K_{\mbox{eff}}}(z,t). \label{eq:S_e(K^eff)}
\end{align}
The dependence of $\MEAN{\nu_{\mbox{eff}}}$ and $\MEAN{K_{\mbox{eff}}}$ on the space and time
coordinates is through the dependence on the distribution function
$f^0_u(u,z,t)$ and the molar fractions of the target species that are
involved in ionization or attachment reactions. As announced, details will
be provided in chapter \ref{ch:sources}.

Along the same lines, integrating equation \eqref{eq:ebe-2term-F-u0} over all
energies after multiplication
with $u$, using equations \eqref{eq:meanu}, \eqref{eq:upduqF/du-int} and
\eqref{eq:Gamma_u} yields (we have also used $\Gamma_eE = -(q_e\Gamma E/e)$
to highlight that the parenthesized term is Ohm's law, with the power in
$\si{eV/m^3/s}$, yuck):
\begin{equation}
	\PDEV{n_u}{t} + \PDEV{\Gamma_u}{z} - (q_e\Gamma_eE)/e= S_u(z,t),
	\label{eq:energy-balance}
\end{equation}
This equation can be recognized as the energy balance equation for the
electrons, with the volumetric (net) power gain of the electrons
in collisions given by
\begin{equation}
	S_u(z,t)
	= n_eN\int\limits_0^\infty u\tilde{C}^0(u)\dd{u}.
	\label{eq:S_u}
\end{equation}

\section{Equations for $f^0_u$ and $f^1_u$}

Substitution of equation \eqref{eq:F=n_ef} in equations
\eqref{eq:ebe-2term-F-u0}--\eqref{eq:ebe-2term-F-u1}, using the fact that $n_e$ does not depend on $u$,
using Leibniz' rule for the differentiation of products and dividing by $n_e$ yields
equations involving $n_e$ and the {\em normalized} distribution functions,
\begin{align}
	&\sqrt{u}f^0_u\frac{1}{n_e}\PDEV{n_e}{t}
	+ \frac{\gamma}{3}uf^1_u\frac{1}{n_e}\PDEV{n_e}{z}
	+\sqrt{u}\PDEV{f^0_u}{t}
	+ \frac{\gamma}{3}u\PDEV{f^1_u}{z}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	= N\tilde{C}^0,
	\label{eq:ebe-2term-f-u0} \\
	&\sqrt{u}f^1_u\frac{1}{n_e}\PDEV{n_e}{t}
	+ \gamma uf^0_u\frac{1}{n_e}\PDEV{n_e}{z}
	+\sqrt{u} \PDEV{f^1_u}{t}
	+ \gamma u \PDEV{f^0_u}{z}
	- E\gamma u\PDEV{f^0_u}{u}
	= -N\sigma_m(u)\gamma uf^1_u.
	\label{eq:ebe-2term-f-u1}
\end{align}
So far, no additional assumptions have been made other than those underlying the
two-term expansion, resulting in equations \eqref{eq:Fv(Fv0,Fv1)},
\eqref{eq:ebe-2term-hagelaar-F-v0} and \eqref{eq:ebe-2term-hagelaar-F-v1}.
In particular, these equations still allow the electron density, the
functions $f^{0,1}_u$, the electric field and other paramers that may influence
the source term $\tilde{C}^0$ to be functions of space and time coordinates.

\section{Solutions for systems of the form $n_e(z,t)f^{0,1}_u(u)$}

At the basis of a number of well-known solutions, such as the spatial and temporal
growth models, to be discussed later, is the simplification of \eqref{eq:F=n_ef} to
\begin{equation}
	F^{0,1}_u(u,z,t)=n_e(z,t)f^{0,1}_u(u),
	\label{eq:F(u,z,t)=n_e(z,t)f(u)}
\end{equation}
that is: the {\em normalized} eedf depends only on $u$, not on space or time coordinates,
whereas $n_e$ depends on position and time. Under these conditions,
equations \eqref{eq:ebe-2term-f-u0}--\eqref{eq:ebe-2term-f-u1} reduce to
\begin{align}
	&\sqrt{u}f^0_u\frac{1}{n_e}\PDEV{n_e}{t}
	+ \frac{\gamma}{3}uf^1_u\frac{1}{n_e}\PDEV{n_e}{z}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	=  N\tilde{C}^0,
	\label{eq:ebe-2term-f-u0(u)} \\
	&\sqrt{u}f^1_u\frac{1}{n_e}\PDEV{n_e}{t}
	+ \gamma uf^0_u\frac{1}{n_e}\PDEV{n_e}{z}
	- E\gamma u\PDEV{f^0_u}{u}
	= -N\sigma_m(u)\gamma uf^1_u.
	\label{eq:ebe-2term-f-u1(u)}
\end{align}
Integration of the first equation over all energies yields
\begin{equation}
	\frac{1}{n_e}\PDEV{n_e}{t}
	+ \MEAN{v_z}\frac{1}{n_e}\PDEV{n_e}{z}
	=  \MEAN{\nu_{eff}},
	\label{eq:t-spat-constraint}
\end{equation}
which shows that the space- and time-derivatives of the electron density are dependent
quantities. One can consider to proceed by eliminating either of them using this
relation. In the following sections we will instead discuss the cases that either of these
terms is assumed to be zero.

TODO: discuss the ramifications of assumption \eqref{eq:F(u,z,t)=n_e(z,t)f(u)} in more
detail, and motivate why/when this assumption makes any sense.

\begin{framed}
TODO/IDEA: is it useful to use constraint \eqref{eq:t-spat-constraint} to eliminate one
the derivatives, and make some general progress, instead of assuming already at that point
that one of the time or spatial derivatives is zero (next sections)? I cannot imagine that
that has not already been tried before.
One could consider to tabulate results as a function not only of $E/N$, but also of
some parameter that describes the relative importance of the two derivatives. For example,
one could write the time and space derivatives as $\nu_t$ and $\alpha_{\mbox{eff}}$, so
\begin{align}
	\nu_t + \MEAN{v_z}\alpha_{\mbox{eff}} = \MEAN{\nu_{eff}}
	\iff
	\nu_t(\alpha_{\mbox{eff}}) = \MEAN{\nu_{eff}} - \MEAN{v_z}\alpha_{\mbox{eff}},
\end{align}
and use this expression to eliminate $\nu_t$ from equations
\eqref{eq:ebe-2term-f-u0(u)}--\eqref{eq:ebe-2term-f-u1(u)}.
\begin{align}
	&\sqrt{u}f^0_u\left(\MEAN{\nu_{eff}} - \MEAN{v_z}\alpha_{\mbox{eff}}\right)
	+ \frac{\gamma}{3}uf^1_u\alpha_{\mbox{eff}}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	=  N\tilde{C}^0,
	\\
	&\sqrt{u}f^1_u\left(\MEAN{\nu_{eff}} - \MEAN{v_z}\alpha_{\mbox{eff}}\right)
	+ \gamma uf^0_u\alpha_{\mbox{eff}}
	- E\gamma u\PDEV{f^0_u}{u}
	= -N\sigma_m(u)\gamma uf^1_u.
\end{align}
One could then calculate/tabulate EEDF results as a function of $E/N$ {\em and} $\alpha_{\mbox{eff}}/N$,
for example. What impact would such more general approach have on fluid models that
use results of the two-term expansion?

Related question: when `complete` data sets are compiled using a 2-term model,
is the choice for temporal/spatial usually docuented? Then that should be followed,
obviously. Is that actually what people do?
\end{framed}

\subsection{Temporal Growth}
The {\em Temporal Growth} model assumes, in addition, that the electron density depends
only on time, yielding
\begin{align}
	&\sqrt{u}f^0_u\frac{1}{n_e}\PDEV{n_e}{t}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	=  N\tilde{C}^0,
	\nonumber \\
	&\sqrt{u}f^1_u\frac{1}{n_e}\PDEV{n_e}{t}
	- E\gamma u\PDEV{f^0_u}{u}
	= -N\sigma_m(u)\gamma uf^1_u.
	\nonumber
\end{align}
For this case, equations \eqref{eq:particle-balance} and \eqref{eq:S_e(K^eff)}
tell us that $\dd{n_e}/\dd{t}=n_eN\MEAN{K_{\mbox{eff}}}$. This allows the second equation
to be rewritten as
\begin{align}
	&f^1_u(u)
	= \frac{E}{N}\frac{1}{\Omega_{pt}(u)}\PDEV{f^0_u}{u},
	\label{eq:ebe-2term-f-u1(u)-temp} \\
	&\Omega_{pt} := \sigma_m(u) + \MEAN{K_{\mbox{eff}}}/(\gamma\sqrt{u}),
	\label{eq:OmegaPT}
\end{align}
and substitution into the first equation yields, after division by $N$,
\begin{equation}
	\sqrt{u}f^0_u\MEAN{K_{\mbox{eff}}}
	- \gamma\left(\frac{E}{N}\right)^2\PDEV{}{u}\left({\cal D}_{pt}^0(u)\PDEV{f^0_u}{u}\right)
	= \tilde{C}^0.
	\label{eq:ebe-2term-f-u0(u)-temp-subst}
\end{equation}
Here we have also introduced the symbol ${\cal D}_x^0(u)$, which is encountered in the
LoKI-B code (but not in the manual), which is defined as
\begin{equation}
	{\cal D}_x^0(u) = \frac{u}{3\Omega_x(u)}.
	\label{eq:D0}
\end{equation}
This symbol will turn out to be useful also in the case of spatial growth, to be discussed next,
and for the evaluation of the electron mobility and diffusion coefficient.

{\bf NOTE: } We repeat one more time that equations \eqref{eq:ebe-2term-f-u1(u)-temp} and
\eqref{eq:ebe-2term-f-u0(u)-temp-subst} can be translated to the corresponding LoKI-B expressions
\cite[eq. 7a with 12a substituted, and 7b]{Manual_2_2_0} by replacing $E\rightarrow -E$ (and
dividing the result by $\gamma$).
Equation \eqref{eq:ebe-2term-f-u0(u)-temp-subst} does not change because it depends on
$(E/N)^2$.

The field operator is of the form $\dd{H_{E,pt}}/\dd{u}$, with
\begin{equation}
	H_{E,x}(u) = - \gamma\left(\frac{E}{N}\right)^2{\cal D}_{x}^0(u)\PDEV{f^0_u}{u}.
	\label{eq:H_E,x}
\end{equation}
Furthermore, following Hagelaar et al., the first term on the left-hand side of
the equation for $f^0(u)$ is defined to be $-\tilde{R}_{pt}$, where
$\tilde{R}_{pt}$ called the `growth renormalization term`,
\begin{equation}
	\tilde{R}_{pt}(u) = -\sqrt{u}f^0_u\MEAN{K_{\mbox{eff}}},
\end{equation}
And bringing this to the right-hand side of the equation, that takes the form that is also
found in \cite[eq. 25]{Hagelaar2005},
\begin{equation}
	\DERIV{H_{E,pt}}{u} = \tilde{C}^0(u) + \tilde{R}_{pt}(u).
\end{equation}


When solving this equation, iterations are needed until the value of
$\MEAN{K_{\mbox{eff}}}$ is consistent with the eedf $f^0(u)$. Note that
the field term needs to be re-discretized as well in every iteration,
since that also depends on $\MEAN{K_{\mbox{eff}}}$ via $\Omega_{pt}(u)$.

Let us now take a look at the electron particle and energy flux densities.
By multiplying equation \eqref{eq:ebe-2term-f-u1(u)-temp} with $\frac{1}{3}\gamma u n_e$,
integration over $u$ and using equation \eqref{eq:Gamma_e} we obtain an
expression for the electron (particle) flux density,
\begin{equation}
	\Gamma_e = (\mu_eN)(E/N)n_e = \mu_eE n_e.
	\label{eq:Gamma_e-temp}
\end{equation}
Here we have introduced the (reduced) electron mobility,
\begin{equation}
	\mu_eN = \gamma\int\limits_0^\infty {\cal D}_{pt}^0(u)\DERIV{f}{u}\dd{u}. \label{eq:mueN}
\end{equation}
The expression for $\mu_eN$ is given in \cite[eq. 46b]{Manual_2_2_0}.
Note that LoKI-B has an additional minus sign in these two equations to make $\mu_e$ positive,
see section \ref{sec:compatibility} for details.

Repeating these steps, but multiplying with $\frac{1}{3}\gamma u^2 n_e$ this time,
yields an expression for the electron {\em energy} flux density,
\begin{equation}
	\Gamma_u = (\mu_uN\MEAN{u})(E/N)n_e = \mu_uE n_e\MEAN{u} = \mu_uE n_u.
	\label{eq:Gamma_u-temp}
\end{equation}
Here we have introduced the (reduced) electron {\em energy} mobility,
\begin{equation}
	\mu_uN = \frac{\gamma}{\MEAN{u}}\int\limits_0^\infty u{\cal D}_{pt}^0(u)\DERIV{f}{u}\dd{u}. \label{eq:muuN}
\end{equation}
\begin{framed}
In the manual, the definitions of $D_u$ and $\mu_u$ in equations 48a-b are different
by a factor $\MEAN{u}$, compared to Hagelaar's definitions \cite[eq. 61,62]{Hagelaar2005}.
In this text we use Hagelaar's definitions --- it appears that in the LoKI-B manual the
coefficients are not used anywhere, and no external references to a discussion or provided,
wheras in Hagelaar's text also the corresponding transport equation for the (mean) energy
is stated and discussed.

The LoKI-B definitions are better called differently: these are known as Allis'
thermoelectricity $\beta$ and heat diffusion $G$. See the discussion below eq. 62
of \cite{Hagelaar2005}. This discussion claims that these Allis coefficients have
also been used by one of the LoKI-B authors (Lu\'is Alves) in \cite{Alves1997},
although I (JvD) have not been able to spot these coefficients in that paper yet.

For consistency, the LoKI-coefficients should also have suffix $u$ instead of $\epsilon$.
\end{framed}
The expression for LoKI-B's $\mu_uN$ is given in \cite[eq. 48b]{Manual_2_2_0}.
Note that again LoKI-B has an additional minus sign in these two equations to make $\mu_u$
positive, see section \ref{sec:compatibility} for details.

TODO: energy balance for the temporal growth model.

\subsection{Temporal Growth for HF Fields}

TODO: This needs to be formulated better and clarified. We should also
provide the complex-valued expression for $f^1(u)$.

Also here, the manual is not compatible with the codes (MATLAB,C++).
In particular, the symbol $\zeta$ is not used.
It is absorbed in the field amplitude, and the field $E$ is the RMS
field (according to the manual, \cite[above eq. 61]{Manual_2_2_0}).

In the equation for $f^0(u)$ that is solved by LoKI-B, the $\zeta$ that appears in
that equation via $G_{E}$ is cancelled by the $1/\zeta$ that is present in $f^1(u)$.
Then $\zeta$ only appears in \SRC{evaluateFirstAnisotropy}.

Summary of the consequences of the HF mode:
\begin{itemize}
  \item $\Omega_{pt}$ (used in the field operator) is modified; it depends
	on the field frequency.
  \item $E$ must be understood as the RMS field, so we replace $E$ with $E\rightarrow E_{rms}$.
  \item In equation \eqref{eq:ebe-2term-f-u1(u)-temp} for $f^1(u)$, the
	field amplitude is needed, as before. We can use $E=E_{rms}\sqrt{2}$ in
	order to express everything in terms of $E_{rms}$.
\end{itemize}

\subsection{Spatial Growth}
The {\em Spatial Growth} model allows only {\em spatial} variations of $n_e$, yielding
\begin{align}
	&
	  \frac{\gamma}{3}uf^1_u\frac{1}{n_e}\PDEV{n_e}{z}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	= N\tilde{C}^0,
	\label{eq:ebe-2term-f-u0(u)-spat-raw}
	\\
	&
	  \gamma uf^0_u\frac{1}{n_e}\PDEV{n_e}{z}
	- E\gamma u\PDEV{f^0_u}{u}
	= -N\sigma_m(u)\gamma uf^1_u.
	\label{eq:ebe-2term-f-u1(u)-spat-raw}
\end{align}
For this case, equations \eqref{eq:particle-balance} and \eqref{eq:S_e(nu^eff)}
tell us that $\dd{\Gamma_e}/\dd{z}=n_e\MEAN{\nu_{\mbox{eff}}}$. Equation \eqref{eq:Gamma_u}
gives the expression for the flux, and equation \eqref{eq:meanvz} makes clear that
$\MEAN{v_z}$ can be taken out of the $\partial/\partial z$, since $f^1(u)$ does not depend
on the spatial coordinate by our assumptions. This gives
\begin{equation}
	\MEAN{v_z}\PDEV{n_e}{z}=n_e\MEAN{\nu_{\mbox{eff}}}.
\end{equation}
For $\MEAN{v_z}\neq 0$ this can be written as
\begin{equation}
	\alpha_{\mbox{eff}} := \frac{1}{n_e}\PDEV{n_e}{z}=\frac{\MEAN{\nu_{\mbox{eff}}}}{\MEAN{v_z}}.
	\label{eq:alpha_eff}
\end{equation}
Using \eqref{eq:alpha_eff} to eliminate the spatial derivative of $n_e$ from equations
\eqref{eq:ebe-2term-f-u0(u)-spat-raw} and \eqref{eq:ebe-2term-f-u1(u)-spat-raw} yields
\begin{align}
	&
	  \frac{\gamma}{3}uf^1_u\alpha_{\mbox{eff}}
	- \frac{\gamma}{3}E\PDEV{u f^1}{u}
	= N\tilde{C}^0.
	\label{eq:ebe-2term-f-u0(u)-spat}
	\\
	&
	f^1_u =
	\frac{1}{\sigma_m(u)}\left(\frac{E}{N}\PDEV{f^0_u}{u}
	- \frac{\alpha_{\mbox{eff}}}{N}f^0_u\right).
	\label{eq:ebe-2term-f-u1(u)-spat}
\end{align}
By multiplying the last equation with $\gamma u/3$, integrating over all energies and
using the definition of ${\cal D}_x^0(u)$ from equation \eqref{eq:D0} we obtain
\begin{equation}
	\MEAN{v_z} = \frac{\gamma}{3}\int\limits_0^\infty uf^1_u\dd{u}
	=
		  E           \frac{\gamma}{N}\int\limits_0^\infty {\cal D}_m^0(u)\PDEV{f^0_u}{u}\dd{u}
		- \alpha_{\mbox{eff}}\frac{\gamma}{N}\int\limits_0^\infty {\cal D}_m^0(u)f^0_u\dd{u}
	= \mu_e E - D_e\alpha_{\mbox{eff}}.
	\label{eq:ebe-2term-f-u1(u)-spat-v_z}
\end{equation}
Here we have used expression \eqref{eq:mueN} for the reduced electron diffusion coefficient
$D_eN$, and introduced the (reduced) electron diffusion coefficient,
\begin{equation}
	D_eN   = \gamma\int\limits_0^\infty {\cal D}_x^0(u)f(u)\dd{u}, \label{eq:DeN}
\end{equation}
The expression for $D_eN$ is given in \cite[eq. 46a]{Manual_2_2_0}.

Combination with equation \eqref{eq:alpha_eff} gives a quadratic equation for $\alpha_{\mbox{eff}}$,
\begin{equation}
	\alpha_{\mbox{eff}}(\mu_eE-D_e\alpha_{\mbox{eff}}) - \MEAN{\nu_{\mbox{eff}}} =0,
\end{equation}
which can be solved to obtain
\begin{equation}
	\alpha_{\mbox{eff}} = \frac{1}{2D_e}\left(\mu_eE \pm\sqrt{(\mu_eE)^2-4D_e\MEAN{\nu_{\mbox{eff}}}}\right).
\end{equation}
The roots are real if $(\mu_eE)^2-4D_e\MEAN{\nu_{\mbox{eff}}}>0$. When simplifying,
note that normally $\mu$ is negative, $E$ could be positive or negative, $\alpha$ has the
same sign as the product $\mu_eE$, and $\MEAN{\nu_{\mbox{eff}}}$ can be positive or negative
(negative if there is more attachment than ionization).
It is zero when the discriminant is zero, or may be complex.
Note that there are two solutions. We choose the one that has the desired property that
$\alpha_{\mbox{eff}}=0$ when $\MEAN{\nu_{\mbox{eff}}}=0$. This can be written as
\begin{equation}
	\alpha_{\mbox{eff}} = \frac{1}{2D_e}\left(\mu_eE -\sgn(\mu_eE)\sqrt{(\mu_eE)^2-4D_e\MEAN{\nu_{\mbox{eff}}}}\right).
	\label{eq:sst-alpha-solution}
\end{equation}
NOTE: if $\mu_eE\neq 0$ this can be written as
\begin{equation}
	\alpha_{\mbox{eff}} = \frac{\mu_eE}{2D_e}\left(1 -\sqrt{1-\frac{4D_e\MEAN{\nu_{\mbox{eff}}}}{(\mu_eE)^2}}\right).
	\label{eq:sst-alpha-solution-muE!=0}
\end{equation}
Substitution of equation \eqref{eq:ebe-2term-f-u1(u)-spat} in equation \eqref{eq:ebe-2term-f-u0(u)-spat}
and dividing by $N$ gives an expression for $f^0(u)$,
\begin{equation}
	  \gamma\frac{\alpha_{\mbox{eff}}}{N}{\cal D}_m^0(u)\left(\frac{E}{N}\PDEV{f^0_u}{u}
        - \frac{\alpha_{\mbox{eff}}}{N}f^0_u\right)
	- \gamma\frac{E}{N}\PDEV{}{u}\left(
		{\cal D}_m^0(u)\left(\frac{E}{N}\PDEV{f^0_u}{u}
		- \frac{\alpha_{\mbox{eff}}}{N}f^0_u\right)
	\right)
	= \tilde{C}^0.
	\label{eq:ebe-2term-f-u0(u)-spat-subst}
\end{equation}
By bringing all terms that depend on $\alpha_{\mbox{eff}}f^0(u)$ to the right-hand side
of the equation and using definition \eqref{eq:H_E,x} with $x=m$, that can be
rewritten as
\begin{equation}
	\DERIV{H_{E,m}}{u} = \tilde{C}^0(u) + \tilde{R}_{sst}(u),
	\label{eq:ebe-2term-f-u0(u)-spat-subst-dH_E/du}
\end{equation}
where, just like for the temporal growth case, a growth renormalization term $\tilde{R}_{sst}(u)$
has been introduced, which is now given by
\begin{equation}
	\tilde{R}_{sst}(u) =
	  -\gamma\frac{\alpha_{\mbox{eff}}}{N}\left[{\cal D}_m^0(u)\left(\frac{E}{N}\PDEV{f^0_u}{u}
        - \frac{\alpha_{\mbox{eff}}}{N}f^0_u\right)
	+ \frac{E}{N}\PDEV{}{u}\left({\cal D}_m^0(u)f^0_u\right)
	\right].
	\label{eq:Rsst-orig}
\end{equation}
We can rewrite equation \eqref{eq:Rsst-orig} by expanding the derivative of the
product ${\cal D}_m^0(u)f^0_u$ and reordering terms,
\begin{align}
	\tilde{R}_{sst}(u)
	  &=-\gamma\frac{\alpha_{\mbox{eff}}}{N}\left[{\cal D}_m^0(u)\left(2\frac{E}{N}\PDEV{f^0_u}{u}
        - \frac{\alpha_{\mbox{eff}}}{N}f^0_u\right)
	+ \frac{E}{N}f^0_u\PDEV{{\cal D}_m^0(u)}{u}
	\right]
	\nonumber \\
	  &= -\gamma\frac{\alpha_{\mbox{eff}}}{N}\left[{\cal D}_m^0(u)2\frac{E}{N}\PDEV{f^0_u}{u}
	+ \left(\frac{E}{N}\PDEV{{\cal D}_m^0(u)}{u}-\frac{\alpha_{\mbox{eff}}}{N}{\cal D}_m^0(u)\right)f^0_u
	\right].
	\label{eq:Rsst-alts}
\end{align}
The first form of this equation is what you find in the BOLSIG+ paper \cite[eq. 19]{Hagelaar2005}
(after changing $\alpha_{\mbox{eff}}\rightarrow -\alpha_{\mbox{eff}}$).
In the last step, the terms involving $f^0_u$ and its derivative have been separated,
which is more convenient when the terms are discretized.
On the other hand, we can use ${\cal D}_m^0(u)\dd{f^0_u}/\dd{u} = \dd{{\cal D}_m^0(u)f^0_u}/\dd{u} - f^0_u\dd{{\cal D}_m^0(u)}/\dd{u}$
to obtain
\begin{align}
	\tilde{R}_{sst}(u)
	= \gamma\frac{\alpha_{\mbox{eff}}}{N}\left[
	  f^0_u(u)\left(\frac{E}{N}\PDEV{{\cal D}_m^0(u)}{u} + \frac{\alpha_{\mbox{eff}}}{N}{\cal D}_m^0(u)\right)
	- 2\frac{E}{N}\PDEV{{\cal D}_m^0(u)f^0_u}{u}
	\right].
\end{align}

\subsubsection{Energy Balance}

Multiplying equation \eqref{eq:ebe-2term-f-u0(u)-spat} with $u$ and integration over $u$
yields the energy balance for the spatial growth case. After multiplication with $n_e$
we get
\begin{equation}
	\alpha_{\mbox{eff}}\Gamma_u -(q_e\Gamma_e/e) E = n_eN\int\limits_0^\infty u \tilde{C}^0(u)\dd{u}.
\end{equation}
Here we have used equation \eqref{eq:Gamma_u}, and the dissipation term is obtained in the
same way as it was in the derivation of equation \eqref{eq:energy-balance}.

The electron energy flux density is given by equations \eqref{eq:Gamma_u}. Substitution
of equation \eqref{eq:ebe-2term-f-u1(u)-spat} for $f^1(u)$ for the spatial growth case yields
\begin{equation}
	\Gamma_u = \frac{E}{N}(\mu_u N)n_e\MEAN{u} - \frac{\alpha_{\mbox{eff}}}{N}(D_uN)n_e\MEAN{u},
	\label{eq:Gamma_u-sst}
\end{equation}
where we have used equation \eqref{eq:muuN} and have defined the (reduced) electron energy diffusion
coefficient $D_uN$ as
\begin{equation}
	D_uN = \frac{\gamma}{\MEAN{u}}\int\limits_0^\infty u{\cal D}_{pt}^0(u)f(u)\dd{u}. \label{eq:DuN}
\end{equation}
\begin{framed}
In the manual, the definitions of $D_u$ and $\mu_u$ in equations 48a-b are different
by a factor $\MEAN{u}$, compared to Hagelaar's definitions \cite[eq. 61,62]{Hagelaar2005}
that have been used here.  See the note below equation \eqref{eq:muuN}.
The expression for LoKI-B's $D_uN$ is given in \cite[eq. 48a]{Manual_2_2_0}.
\end{framed}

The particle flux density is obtained by multiplying equation \eqref{eq:ebe-2term-f-u1(u)-spat-v_z}
with $n_e$,
\begin{equation}
	\Gamma_z = n_e(\mu_e E - D_e\alpha_{\mbox{eff}}).
\end{equation}
The expression for $\Gamma_z$ can be used to evaluate the power that is absorbed per electron
at unit background gas density by the field directly, the result can be written as
\begin{equation}
	\frac{P_E}{N} := \frac{q_e}{e}\frac{\Gamma_zE}{n_eN} = \frac{q_e}{e}\left((\mu_eN) \frac{E}{N} - (D_eN)\frac{\alpha_{\mbox{eff}}}{N}\right)\frac{E}{N}.
\end{equation}
Substitution of equation \eqref{eq:sst-alpha-solution} yields
\begin{equation}
	\frac{P_E}{N} = \frac{q_e}{e}\left(\frac{E}{N}\right)^2(\mu_eN)\frac{1}{2}\left(1 +\sqrt{1-\frac{4D_e\MEAN{\nu_{\mbox{eff}}}}{(\mu_eE)^2}}\right),
\end{equation}
which is equivalent to the result found in the BOLSIG+ manual \cite[p. 18]{BolsigManual2016}
(item 19.) for the spatial growth case.
\begin{framed}
NOTE/TODO: the expression after substitution of the solution of $\alpha_{\mbox{eff}}$ above is
only valid for $E\neq 0$. This is based on the last form of
\begin{equation}
	\MEAN{v_z}
	=\frac{\Gamma_z}{n_e}
	= \frac{\mu_e E}{2} +\frac{1}{2}\sgn(\mu_eE)\sqrt{(\mu_eE)^2-4D_e\MEAN{\nu_{\mbox{eff}}}}
	= \frac{\mu_e E}{2}\left(1 +\sqrt{1-\frac{4D_e\MEAN{\nu_{\mbox{eff}}}}{(\mu_eE)^2}}\right),
\end{equation}
but also the case $E=0$ should be captured here, suggesting the intermediate form. (That will have
a positive discriminant if $\MEAN{\nu_{\mbox{eff}}}<0$.)
\end{framed}

Alternatively, the term from the field operator
that is proportional to $\alpha_{\mbox{eff}}$ can be combined with the first term on the
left-hand side of the energy balance, thus combining all terms that are related to the
spatial inhomogeneities. Substitution of the expression for $\Gamma_z$ and equation
\eqref{eq:Gamma_u-sst} in the energy balance and division by $Nn_e$ result in
\begin{equation}
	\frac{\alpha_{\mbox{eff}}}{N}\MEAN{u}\left(\frac{E}{N}(\mu_u N) - \frac{\alpha_{\mbox{eff}}}{N}(D_uN)\right)
	- \frac{q_e}{e}\left((\mu_eN) \frac{E}{N} - (D_eN)\frac{\alpha_{\mbox{eff}}}{N}\right)\frac{E}{N}
	= \int\limits_0^\infty u \tilde{C}^0(u)\dd{u},
\end{equation}
and regrouping terms yields
\begin{equation}
	-\frac{\alpha_{\mbox{eff}}}{N}\left(
		\MEAN{u}\left[\frac{\alpha_{\mbox{eff}}}{N}(D_uN) - \frac{E}{N}(\mu_u N)\right]
		- \frac{q_e}{e} (D_eN)\frac{E}{N}
	\right)
	- \frac{q_e}{e}\left(\frac{E}{N}\right)^2(\mu_eN)
	= \int\limits_0^\infty u \tilde{C}^0(u)\dd{u}.
\end{equation}
The first term (negated) now corresponds to the `growth power' (item 22) in \cite[p. 19]{BolsigManual2016}
(after negating both $\alpha_{\mbox{eff}}$ and $\mu_u$, see section \ref{sec:compatibility},
\begin{equation}
	\frac{P_{growth,sst}}{N} =
	\frac{\alpha_{\mbox{eff}}}{N}\left(
		\MEAN{u}\left[\frac{\alpha_{\mbox{eff}}}{N}(D_uN) - \frac{E}{N}(\mu_u N)\right]
		- \frac{q_e}{e} (D_eN)\frac{E}{N}
	\right).
\end{equation}
\begin{framed}
This is confusing in the BOLSIG+ manual (or maybe an error, it depends on the definitions),
which suggests that the field power with growth term {\em and} the growth power
as stated here are part of the power balance (in the NB just before item 24 on page 19).
\end{framed}

\noindent {\bf Notes and Questions --- Theory:}
\begin{itemize}
\item Why don't the BOLSIG+ and LoKI-B documents address the existence and significance of a second root?
	Why should the second solution of the equation for $\alpha_{\mbox{eff}}$ be rejected?
\item The physical significance of $\MEAN{v_z}=0$ is that the drift and diffusion
	velocities are equal (but opposite). Then the above definition fails. How
	can we fix this?
	For $\MEAN{v_z}=0$ should we adopt $\alpha_{\mbox{eff}}=0$? We
	also want $\alpha_{\mbox{eff}}=0$ if $\MEAN{\nu_{\mbox{eff}}}=0$.
	What if the velocity and frequency are {\em both} zero?
\item Why should complex roots (if any) be ignored/patched? Physically
	these would result in oscillatory $n_e(z)$. Is that wrong per se?
	Are these in conflict with any prior assumption? Then that should be
	explained.
\end{itemize}
\noindent {\bf Which Form is Discretized in LoKI-B?}
\begin{itemize}
\item In the LoKI-B {\em manual} \cite[eq. 8a--b,
	29--30c,32]{Manual_2_2_0}, essentially equation
	\eqref{eq:ebe-2term-f-u0(u)-spat-subst} is presented --- the field
	operator is modified to also describe part of the growth effects.
\item This is {\em not} what is in the LoKI-B code. That is based on
	\eqref{eq:ebe-2term-f-u0(u)-spat-subst-dH_E/du} and one of the
	forms of the growth renormalization term (after $E\rightarrow -E$
	and division by $1/\gamma$). But which one?
	\begin{itemize}
		\item \SRC{fieldOperator} provides the term that is also present in the absence of growth.
		\item \SRC{fieldMatrixSpatGrowth} appears to provide
		\[
			\frac{\alpha_{\mbox{eff}}}{N}\frac{E}{N}\DERIV{D^0f^0}{u}.
		\]
		\item \SRC{ionSpatialGrowthD} provides $(\alpha_{\mbox{eff}}/N)^2{\cal D}_{sst}^0$.
		\item This suggests that \eqref{eq:Rsst-orig} is used, and the remaining
			term is $\frac{\alpha_{\mbox{eff}}}{N}\frac{E}{N}D^0(u)\DERIV{f^0}{u}$.
			A central-difference scheme
			for the derivative of $f(u)$ yields
			\begin{equation}
				\frac{\alpha_{\mbox{eff}}}{N}\frac{E}{N}{\cal D}_{sst}^0(u)\DERIV{f}{u}
				\doteq
				\frac{\alpha_{\mbox{eff}}}{N}\frac{E}{N}{\cal D}_{sst}^0(u_k)\frac{f_{k+1}-f_{k-1}}{2\Delta u},
			\end{equation}
			which corresponds to the second term of the manual's equation (29).
			The manual does not explain how to handle the first and last cells,
			but for those the derivatives can of course be approximated with the
			asymmetric approximations $(f_1-f_0)/\Delta$ and
			$(f_{{\cal N}-1}-f_{{\cal N}-2})/\Delta u$.

			BUT THIS DOES TERM NOT SEEM TO BE PROVIDED BY THE remaining discretization
			matrix in the code, \SRC{ionSpatialGrowthU}.
	\end{itemize}
\item Confusion is caused in the code by the fact that the
	helper array \SRC{g_eeSpatialGrowth}, which is used in the implementation
	of the \SRC{fieldMatrixSpatGrowth}, has a division by 6,
	instead of by 3 (\SRC{Boltzmann.m} line 1112 in version
	2.2.0), because that array also absorbs the factor $1/2$ that comes from the
	averaging $f_{n\pm\frachalf}=(f_n+f_{n\pm 1})/2$ in the discretization process of
	$G_x(u_{k\pm\frachalf})$ (that is practically the factor $1/2$ in equation
	\ref{eq:-dGdu/Ngamma-discrete}).

	In the C++ code, \SRC{g_eeSpatialGrowth} is defined as in the documentation,
	and the factor 2 is taken into account where it should be, by writing $2\Delta u$
	instead of $\Delta u$ in the discretization of the Boltzmann matrix, consistent
	with the $G_x(u)$ exposition. We also had to add the division by 2 in the
	interpolation code
	\SRC{(g_fieldSpatialGrowth[k + 1] + g_fieldSpatialGrowth[k])/2} in
	the only other location where the array is used (which also makes it easier
	understand that an interpolation to a cell value is happening in that code).
	In MATLAB (version 2.2.0) that last code can be found in
	\SRC{Boltzmann.m} line 1512.
\item It appears that the MATLAB version of the growth codes has been revised
	significantly since the C++ version was created from the 1.0.0 MATLAB code.
	Various issues that were reported in the (C++) source code may have
	been resolved, maybe not. A full comparison of the C++ code and current MATLAB
	version is due.
\end{itemize}

\section{The evaluation of $D_eN$ and $\mu_eN$}

The expressions for $D_eN$ and $\mu_eN$ are given in equations
\eqref{eq:DeN} and \eqref{eq:mueN}.

In the code, the drift velocity $v_d=-\mu_eE=-(\mu_eN) \times (E/N)$ is evaluated,
rather than the mobility. To that end, the code defines four arrays on the cell
domain ($0\leq k<{\cal N}$) (in \SRC{solveSpatialGrowthMatrix}):
\begin{align}
	{\cal D}^0_k &= \frac{u_k}{3\Omega_k}, \\
	{\cal U}^-_k &= +\frac{E}{N}\begin{cases}
				0 & k=0 \\
				{\cal D}^0_{k-1}/(2\Delta u), & 0<k<{\cal N}\\
			\end{cases} \\
	{\cal U}^+_k &= -\frac{E}{N}\begin{cases}
				{\cal D}^0_{k+1}/(2\Delta u), & 0\leq k<{\cal N}-1\\
				0 & k={\cal N}-1 \\
			\end{cases} \\
	{\cal U} &= {\cal U}^+ + {\cal U}^-.
\end{align}
The approximation of $D_N$ is straightforward: $D_eN \doteq \gamma \sum_k {\cal D}^0_kf_k\Delta u$, and this
is also what you find in the code. The evaluation of $\mu_eE$ is not clear to me at all. In the code we have
\begin{align}
	\mu_eE
		&= -\gamma \sum\limits_{k=0}^{{\cal N}-1} {\cal U}_kf_k\Delta u \nonumber \\
		&= -\gamma \sum\limits_{k=0}^{{\cal N}-1} ({\cal U}^+_k + {\cal U}^-_k)f_k\Delta u \nonumber \\
		&= +\gamma \frac{E}{N}\left(
			\frac{{\cal D}^0_{1}}{2\Delta u}
			+ \sum\limits_{k=1}^{{\cal N}-2}\frac{{\cal D}^0_{k+1}-{\cal D}^0_{k-1}}{2\Delta u}
			-\frac{{\cal D}^0_{{\cal N}-2}}{2\Delta u}\right)f_k\Delta u \nonumber \\
		&\doteq +\gamma \frac{E}{N}\left(
			\frac{{\cal D}^0_{1}}{2\Delta u}
			+ \sum\limits_{k=1}^{{\cal N}-2}\left[\DERIV{D^0}{u}\right]_k
			-\frac{{\cal D}^0_{{\cal N}-2}}{2\Delta u}\right)f_k\Delta u.
\end{align}
I (JvD) can {\em almost} understand this by doing a partial integration of the expression for $\mu_eN$, yielding
\[
	\mu_eN
		= \gamma\int\limits_0^\infty {\cal D}^0 \DERIV{f}{u}\dd{u}
		= \left. {\cal D}^0(u)f(u)\right|_0^\infty - \gamma\int\limits_0^\infty \DERIV{{\cal D}^0}{u} f(u)\dd{u}
		=  - \gamma\int\limits_0^\infty \DERIV{{\cal D}^0}{u} f(u)\dd{u},
\]
since $D^0(0)=0$ and assuming that $\lim\limits_{u\rightarrow\infty}({\cal D}^0(u)f(u)) = 0$.
We now see that the approximation makes sense ... except for the first and last cell, where we have
${\cal D}^0_{k\pm 1}/(2\Delta u)$, instead of an approximation for the derivative of $D^k$ in $u_k$.
A correct expression is obtained by replacing the term ${\cal D}^0_{1}/(2\Delta u)$
with the first order expression $({\cal D}^0_{1}-{\cal D}^0_{0})/\Delta u$ of the derivative.
Since ${\cal D}^0(u=0)=0$, an alternative expression would be $({\cal D}^0_{0}-{\cal D}^0(u=0))/(\Delta u/2)
={\cal D}^0_{0}/(\Delta u/2)=2{\cal D}^0_{0}/\Delta u$, it seems.
At the upper side, ${\cal D}^0_{{\cal N}-2}/(2\Delta u)$ should be
$({\cal D}^0_{{\cal N}-1}-{\cal D}^0_{{\cal N}-2})/\Delta u$.
Such fixes can be translated back in modifications of ${\cal U}^-$ and ${\cal U}^+$, of course,
but note that those are also used in the assembly of one of the spatial growth discretisation
matrices.
\begin{framed}
  This problem is tested by \SRC{tests/test_trans_coefs.cpp}.
\end{framed}


\chapter{Collisional Source Terms}
\label{ch:sources}

\section{Notation, Conservative Source Terms}

Let us now take a look at the source terms $\tilde{C}^0(u)$. We will soon see
that some of these can be written in flux-divergence form,
\begin{equation}
	\tilde{C}^0_x(u) = -\DERIV{H_x(u)}{u}.
	\label{eq:Ctilde=-dH/du}
\end{equation}
The reason for introducing the minus sign here is that, as we shall soon see
(equation \eqref{eq:H_x-expr}), the resulting expressions for the fluxes $H_x(u)$
will be of the advection-diffusion type,
\[
	H_x(u) = -h_x(u)\left(c_x(u) f^0(u) + d_x(u) f^0(u)\right)
	       = -h_x(u)c_x(u) f^0(u) - h_xd_x(u) f^0(u),
\]
with a {\em positive} diffusion coefficient $h_x(u)d_x(u)$.
This choice of sign is also compatible with the field term $\dd{H_{E,x}}/\dd{u}$,
with $H_{E,x}$ as given in equation \eqref{eq:H_E,x} (which is purely diffusive).
NOTE: LoKI-B docs call the convection coefficient $c_x$ and the diffusion
coefficient $d_x$ --- which is somewhat unfortunate --- also see
section \ref{sec:dH/du-disc}.

\section{Compatibility Notes}
In the LoKI-B presentation (manual), these are moved to the left-hand side of the equation for $f^0_u(u)$,
and all terms of the final equation are divided by $\gamma$. As a result, in the manual they appear as
\begin{equation}
	\frac{\tilde{C}_x(u)}{\gamma} := -\frac{1}{N\gamma}\DERIV{G^{man}_x}{u}, \quad\mbox{with}\quad G^{man}_x(u)=N H_x(u).
	\label{eq:CvsGman}
\end{equation}
In the {\em code} (matlab and C++), no tricks are done, the terms are all brought
to the {\em right-}hand side of the equation the source terms are discretized as
\begin{equation}
	\frac{\tilde{C}_x(u)}{\gamma} = -\frac{1}{\gamma}\DERIV{H(u)}{u}
\end{equation}
NOTE that the functions $H_x(u)$ in this text are defined {\em without}
the factor $1/\gamma$.

\section{The Elastic Source Term}

For the elastic source term $\tilde{C}_{el}$, \cite[eq. 27]{Hagelaar2005} gives the
expression for a single target species. By
summing we get the total elastic term. This can be written as
\begin{equation}
	\tilde{C}^0_{el}(u)=-\PDEV{H_{el}}{u},
	\label{eq:Ctilde0-el}
\end{equation}
with
\begin{equation}
	H_{el}(u) = -\gamma u^2\left(\sum\limits_k x_k\frac{2m}{M_k}\sigma_{m,k}(u)\right)\left(f^0(u)+\frac{k_BT}{e}\PDEV{f^0}{u}\right)
	= -\gamma u^2\sigma_{u}(u)\left(f^0(u)+\frac{k_BT}{e}\PDEV{f^0}{u}\right).
\end{equation}
In this expression, the total elastic energy transfer cross section has been
defined as \cite[eq. 42]{Hagelaar2005}
\begin{equation}
	\sigma_{u}(u) := \sum\limits_k x_k\frac{2m}{M_k}\sigma_{m,k}(u).
\end{equation}
In the LoKI-B {\em code}, we find this term exactly like this, after division by $\gamma$ (see the
compatibility notes). Note that the minus signs in the expressions for $\tilde{C}^0_{el}(u)$
and $H_{el}(u)$ cancel out.

The LoKI-B flux function $G^{man}_{el}(u)$, that is reported in the {\em manual}
\cite[eq. 12b]{Manual_2_2_0} is given by
\begin{equation}
	G^{man}_{el}(u)
	:= -u^{3/2}\nu_{u}(u)\left(f^0(u)+\frac{k_BT}{e}\PDEV{f^0}{u}\right).
	\label{eq:Ctilde0-el-loki}
\end{equation}
With the relations $\nu_{u}(u)=N\sigma_{u}(u)v(u)$ and $\gamma u^2=v(u)u^{3/2}$
this can be written as
\begin{equation}
	G^{man}_{el}(u) = -N\gamma u^2\sigma_{u}(u)\left(f^0(u)+\frac{k_BT}{e}\PDEV{f^0}{u}\right).
\end{equation}
And after division by $N$ we obtain $H_{el}(u)$, as expected.

\begin{framed}
	In the manual, the symbol $\nu^{el}_{k,c}$ is used for the elastic {\em momentum} transfer collision
	frequency. That is better called $\nu_{k,c}$, since it is just $N_k\sigma_{k,c}v(u)$. (See the
	definition of the $\nu_{0,k}$, that does it `correct').
	That said, I think this frequency should be avoided, the code should be followed.

	In the code, the term \SRC{elasticCrossSection} is used for the elastic {\em energy transfer}
	cross section. What is the correct terminology? (Above I wrote $\sigma_{u}$ for the
	energy transfer cross section, following Hagelaar. That avoids this confusion.)
\end{framed}

\section{The CAR Source Term}
The CAR source term is of the form \eqref{eq:Ctilde=-dH/du},
\begin{equation}
	\tilde{C}^0_{car}(u) = -\PDEV{H_{car}}{u},
\end{equation}
with
\begin{equation}
	H_{car}(u) = -4\gamma\sigma_{car}u\left[f^0(u) + \frac{k_BT_g}{e}\PDEV{f^0}{u}\right].
\end{equation}
and the CAR cross section
\begin{equation}
	\sigma_{car}=\sum\limits_k B_k x_k\sigma_{0,k}.
\end{equation}

In the LoKI-B manual it is represented by \cite[eq. 12c]{Manual_2_2_0}
\begin{equation}
	G^{man}_{car}(u) = -\sum\limits_k 4B_k\nu_{0,k}\sqrt{u}\left[f^0(u) + \frac{k_BT_g}{e}\PDEV{f^0}{u}\right].
\end{equation}
Substituting $\nu_{0,k}=Nx_k\sigma_{0,k}v(u)=Nx_k\gamma\sigma_{0,k}\sqrt{u}$, this can
be written in terms of a cross section as
\begin{equation}
	G^{man}_{car}(u)
		= -N\gamma\sum\limits_k 4B_k x_k\sigma_{0,k}u\left[f^0(u) + \frac{k_BT_g}{e}\PDEV{f^0}{u}\right]
		= -N\gamma 4\sigma_{car}u\left[f^0(u) + \frac{k_BT_g}{e}\PDEV{f^0}{u}\right]
\end{equation}
Equation \eqref{eq:CvsGman} confirms that $G^{man}_{car}(u) = NH_{car}$.


\section{Excitation and Deexcitation}

Consider an excitation reaction $r$ of the form $A_p + e \rightarrow A_q + e$ with
cross section $\sigma_{pq}$ in which the electron {\em loses} an amount of energy
$u_{pq}:=u_q-u_p$. If the initial energy of the electron is $u_i$, one such reaction
event will remove one electron with energy $u_i$ from the distribution, and
place it back at energy $u_f=u_i-u_{pq}$. If $u_{pq}>0$, obviously the initial electron
must have $u_i\geq u_{pq}$.

The electrons that contribute to the source $\tilde{C}^0_{in}$ at energy value $u$
are the following:
\begin{itemize}
	\item Those with initial energy $u_i=u+u_{pq}$ and final energy $u_f=u$ (source),
	\item Those with initial energy $u_i=u$ and final energy $u_f=u-u_{pq}$ (sink).
\end{itemize}
The source term is then
\begin{equation}
	\tilde{C}^0_{in,r-fwd}(u)
	=  \delta_p \gamma[
		\sigma_{pq}(u+u_{pq})(u+u_{pq})f^0(u+u_{pq})
		-
		\sigma_{pq}(u)uf^0(u)
	].
\end{equation}

The cross section of the corresponding backward processes can be obtained with
the Klein-Rosseland relation \cite{Klein1921}, also see section
\ref{app:KleinRosseland}, which states that
\begin{equation}
	\sigma_{qp}(u)
	=
	\sigma_{pq}(u+u_{pq})\frac{g_p}{g_q}\frac{u+u_{pq}}{u}.
	\label{eq:KleinRosseland}
\end{equation}
If this reverse reaction is enabled, two additional terms emerge due to the
process $A_q + e \rightarrow A_p + e$ with cross section $\sigma_{qp}(u)$
and energy $u_{qp}=-u_{pq}$:
\begin{itemize}
	\item Those with initial energy $u_i=u-u_{pq}$ and final energy $u_f=u$ (source),
	\item Those with initial energy $u_i=u$ and final energy $u_f=u+u_{pq}$ (sink).
\end{itemize}
Using \eqref{eq:KleinRosseland}, the additional terms are then
\begin{align}
	\tilde{C}^0_{in,r-rev}(u)
	&=  \delta_q \gamma[
		\sigma_{qp}(u-u_{pq})(u-u_{pq})f^0(u-u_{pq})
		-
		\sigma_{qp}(u)uf^0(u)
	]
	\nonumber \\
	&=  \delta_q \gamma\frac{g_p}{g_q}\left[
		\sigma_{pq}(u)\frac{u}{u-u_{pq}}(u-u_{pq})f^0(u-u_{pq})
		-
		\sigma_{pq}(u+u_{pq})\frac{u+u_{pq}}{u}uf^0(u)
	\right]
	\nonumber \\
	&=  \delta_q \gamma\frac{g_p}{g_q}\left[
		\sigma_{pq}(u)uf^0(u-u_{pq})
		-
		\sigma_{pq}(u+u_{pq})(u+u_{pq})f^0(u)
	\right].
\end{align}

TODO:
\begin{itemize}
	\item In the manual \cite[eq. 13a]{Manual_2_2_0} it is suggested that
		the reverse reaction is always taken into account, but that
		is not true. Clarify.
	\item Explain how out-of-grid terms are handled, and explain that
		it is  ensured that the operator is conserved.
\end{itemize}

\section{Ionization}

For derivations, see \ref{app:ionization}.
\begin{itemize}
	\item One-takes-all:
	\begin{equation}
		\tilde{C}^0_{ion,i}(u)
		=\gamma\delta_i\left[
			(u+V_{ion,i})\sigma_{ion,i}(u+V_{ion,i})f^0(u+V_{ion,i})
			+
			\delta(u)\MEAN{K_{ion,i}}
			-
			u\sigma_{ion,i}(u)f^0(u)
		\right],
		\label{eq:Ctilde0-ion-onetakesall}
	\end{equation}
	with
	\[
		\MEAN{K_{ion,i}} = \gamma\int\limits_{V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')f^0(u')\dd{u'}.
	\]
	\item Equal sharing:
	\begin{equation}
		\tilde{C}^0_{ion,i}(u)=\gamma\delta_i\left[
			4(2u+V_{ion,i})\sigma_{ion,i}(2u+V_{ion,i})f^0(2u+V_{ion,i})
			-
			u\sigma_{ion,i}(u)f^0(u)
		\right].
		\label{eq:Ctilde0-ion-equalsharing}
	\end{equation}
\end{itemize}


TODO:
\begin{itemize}
	\item in the \SRC{oneTakesAll} case, electrons are injected
		in the first cell $(u=\Delta u/2$), instead of at $u=0$,
		which is stated in the manual.
		Explain the impact of this difference and make sure
		that the energy balance is not affected.
        \item \SRC{OPBParamater} is input, but $\beta=2$ appears to be hardcoded (MATLAB and C++).
		Only then is the function integrable analytically over $u'$. Also,
		the property below \cite[eq. 63]{Manual_2_2_0}) is true only
		if $\beta=2$, so the manual should more clear that is required
		(and used in the code), even though the function that is
		recommended by Opal et al. \cite[fig. 4, text below tab. 1]{Opal1971}
		has $\beta=2.1$. What is the impact of these
		deviations? The manual should be more clear about that.
		Small issue: the usage of $(u,u')$ vs $(u',u)$ as formal parameter
		lists in equations 14 and 63 of the manual could be made consistent.
	\item The derivations (see section \ref{app:ionization} rely on the peak
		of a delta-function being fully enclosed by an integration
		interval, when it is located on its boundary. This is mathematically
		not sound. Unfortunately, neither the LoKI Manual, nor the BOLSIG+
		paper gives a reference to the starting point of the derivations,
		eq. \eqref{eq:Ctilde0-ion}, so we cannot easily trace back what is
		happening here.
	\item The BOLSIG+ paper has a different expression for the equal sharing case:
		there is a factor 2 in front of the second term of \cite[eq. 29]{Hagelaar2005},
		whereas equation \eqref{eq:Ctilde0-ion-equalsharing},
		\cite[eq. 16]{Manual_2_2_0} and \cite[eq. 10]{Tejero2019} have a factor 4.
		{\bf This a bug in the BOLSIG+ paper, it seems. See \ref{app:ionization} for an analysis.}
\end{itemize}


\section{Attachment}
For any background gas (state) $i$:
\begin{equation}
	\tilde{C}^0_{att,i}=-\gamma \delta_i u\sigma_{i,att}(u)f^0(u).
	\label{eq:Ctilde0-att}
\end{equation}
The total attachment source is obtained by summing over all states $i$ for
which an attachment reaction has been specified, $\sigma_{i,att}(u)$ is the
cross section for that process.

TODO: in the code we see \SRC{attachmentConservativeMatrix}, but the manual
\cite[below eq. 16]{Manual_2_2_0} claims that attachment is alwas non-conserving,
so that a growth model must be used. Explain the name \SRC{attachmentConservativeMatrix}
and explain its role in solving the EBE.

\section{Electron-Electron Collisions}
\label{sec:ee-operator}

Electron-electron collisions are described by a source term of the form
\eqref{eq:Ctilde=-dH/du}:
\begin{align}
	\tilde{C}^0_{ee}(u) &= -\DERIV{H_{ee}}{u},
	\label{eq:Ctilde0-ee} \\
	H_{ee}(u) &= -h_{ee}\left(I(u)f(u) + J(u)\DERIV{f}{u}\right),
	\label{eq:H_ee} \\
	h_{ee} &= 3\alpha_{eV}\frac{n_e}{N}.
	\label{eq:x_ee}
\end{align}
In the expressions for $H_{ee}(u)$ and $h_{ee}$ we have introduced
\begin{equation}
	\alpha_{eV} = \frac{1}{24}\frac{e^2}{\pi\epsilon_0^2}\gamma\ln\Lambda_c,
	\label{eq:alpha_eV}
\end{equation}
and the `Spitzer integrals' $I(u)$ and $J(u)$ are given by \cite[eqns. 59--62]{Ferreira2000}
\begin{align}
	I(u) &= \int\limits_0^u f(u')\sqrt{u'}\dd{u'}, \label{eq:I} \\
	J(u) &= \frac{2}{3}\left(
		\int\limits_0^u f(u')(u')^{3/2}\dd{u'}
		+
		u^{3/2}\int\limits_u^\infty f(u')\dd{u'}
		\right). \label{eq:J}
\end{align}
This notation $\alpha_{eV}$ is due to Rockwood \cite[below equation B1]{Rockwood1973} and is further explained
in section \ref{sec:Rockwood1973EE}, where the reader will also find a complete derivation of the
expressions that are used in LoKI-B for the electron-electron collision term. Rockwood's expressions
have been modified for the usage in LoKI-B, BOLSIG+ and this text of $\si{eV}$ as energy unit,
which has been made clear with the suffix $\si{eV}$ on Rockwood's $\alpha$.

This expression is equivalent to equation 38 in the BOLSIG paper \cite{Hagelaar2005},
but in that paper $a$ is written instead of $\alpha_{eV}/3$ and functions $A_1$ , $A_2$ and
$A_3$ are used instead of $I(u)$ and $J(u)$.

The LoKI-B {\em code} just implements equation \eqref{eq:Ctilde0-ee}, divided by $\gamma$.
In the LoKI-B {\em paper} \cite[eqn. 6d]{Tejero2019} and {\em manual} \cite[eq. 37a,38]{Manual_2_2_0},
the electron-electron operator is represented by a flux function $G_{ee}(u)$,
\begin{equation}
	G_{ee}(u) = -2\nu_{ee}u^{3/2}\left[I(u)f(u) + J(u)\DERIV{f}{u}\right].
	\label{eq:G(u)-original}
\end{equation}
In the text below that equation, the electron-electron collision frequency $\nu_{ee}$ is given by
\begin{align}
	\nu_{ee} &= 4\pi\left(\frac{e^2}{4\pi\epsilon_0 m_e}\right)^2\frac{\ln\Lambda_c}{v^3}n_e, \\
	\Lambda_c &= 12\pi\lambda_D^3n_e,
\end{align}
where $\lambda_D$ is the Debye length. We assume that the usual expression for electrons
with ion shielding is assumed, in which case (NOTE: with $T^{si}_e$ in SI units $\si{K}$
and $T_e$ the expression in electron-volt, used in LoKI-B)
\begin{equation}
	\lambda_D
	= \sqrt{\frac{\epsilon_0kT^{si}_e}{n_e e^2}}
	= \sqrt{\frac{\epsilon_0(kT^{si}_e/e)}{n_e e}}
	= \sqrt{\frac{\epsilon_0T_e}{n_e e}}.
\end{equation}
The factor $2\nu_{ee}u^{3/2}$ can be simplified using the relation $v=\gamma\sqrt{u}$
and definition \eqref{eq:alpha_eV} of $\alpha_eV$,
\begin{equation}
	2\nu_{ee}u^{3/2}
	= 8\pi\left(\frac{e^2}{4\pi\epsilon_0 m_e}\right)^2\frac{\gamma\ln\Lambda_c}{\gamma^4}n_e
	= 8\pi\left(\frac{e^2}{4\pi\epsilon_0 m_e}\right)^2\gamma\left(\ln\Lambda_c\right)\frac{m_e^2}{4e^2}n_e
	= \frac{e^2}{8\pi\epsilon_0^2}\gamma\left(\ln\Lambda_c\right) n_e
	= 3\alpha_{eV} n_e;
	\label{eq:g_ee-alpha}
\end{equation}
backsubstitution in equation \eqref{eq:G(u)-original} yields
\begin{equation}
	G_{ee}(u) = -3\alpha_{eV} n_e\left[I(\epsilon)f_\epsilon + J(\epsilon)\PDEV{f_\epsilon}{\epsilon}\right].
	\label{eq:G(u)}
\end{equation}
Equation \eqref{eq:CvsGman} tells us that this result is consistent with
expression \eqref{eq:Ctilde0-ee} (as expected).

In the manual \cite[eq. 37a]{Manual_2_2_0}, a factor $g_{ee}$ is used in the definition of $G_{ee}(u)$,
which is defined as
\begin{equation}
	g_{ee}(u) := \frac{2\nu_{ee}u^{3/2}}{N\gamma}.
\end{equation}
We have just learned that this can be written as
\begin{equation}
	g_{ee}(u) = \frac{3\alpha_{eV}}{\gamma}\frac{n_e}{N}.
\end{equation}

\begin{framed}
A small literature interlude ---
In the manual \cite{Manual_2_2_0}, references to \cite{Allis1956} (Allis, 1956) and to
\cite{Ferreira2000} (Ferreira, 2000) are provided for the electron-electron operator.
The `Spizer functions' are not written in the manual, but can indeed be found in
\cite[eqns. 59--62]{Ferreira2000}.

In \cite{Ferreira2000}, Ferreira provides references to (again) \cite{Allis1956} and to a previous
work \cite{Ferreira1984} (Ferreira 1984), where the same material appears in equations 10-13
and a reference to (again) \cite{Allis1956} is provided. In other words, all references
ultimately resolve to Allis' work, but unfortunately in none of the works citing Allis a
section or page number is provided. An inspection of Allis' work leads me (JvD) to the integrals
$I_j^l$ and $J_j^l$ that appear in \cite[eq. 51.8]{Allis1956} and to the coefficients
$\gamma_\xi$ and $\gamma_{\xi\xi}$ and $g_v$ that appear in equations \cite[eq. 53.3-5]{Allis1956}.
It would be nice to be able to read how those expressions translate to the particular expressions
in LoKI-B. (Note BTW that Allis uses a velocity/speed representation of the EEDF.)

Tejero et al. \cite[above eq. 6a]{Tejero2019} provide a reference to \cite{Shkarofsky1966}
(Shkarofsky et al. 1966) for the electron-electron operator. An inspection reveals that this
material can be found around page 284, in particular in eq. 7-87. It still has to be confirmed
that a conversion from their speed representation to LoKI-B's energy-in-$\si{eV}$ representation
results in LoKI-B's expressions.

Another source for this material, that is also used by the BOLSIG+ Boltzmann solver \cite{Hagelaar2005}
is Rockwood's 1973 paper \cite{Rockwood1973}. Appendix \ref{sec:Rockwood1973EE} of the present
text contains a derivation of LoKI's expressions, starting from the presentation of Rockwood.
\end{framed}

Observations:
\begin{itemize}
  \item In spite of the notation, $g_{ee}(u)$ does {\em not} depend on the energy $u$;
    it depends only on the degree of ionization $n_e/N$ and on the Debye length
    (which depends on the ratio $T_e/n_e$). In equations \cite[39a--b]{Manual_2_2_0}
    the suggestion is made once more that $g_{ee}$ is energy-dependent.
  \item The factor $g_{ee}(u)$ is not used consistently. In many places we find
    the expanded form $\frac{2\nu_{ee}u^{3/2}}{N\gamma}$ for no good reason
    (e.g. in \cite[eqn. 39a-g]{Manual_2_2_0}).
    Using $g_{ee}$ instead simplifies the expressions considerably and makes clear
    that this product does not depend on the energy $u$.
  \item NOTE that the definition of $g_{ee}(u)$ differs from that of the other
    $g_x(u)$, in the sense that it is {\em not} the coefficient of the advective
    part of $G(u)$ (in energy space) --- see section \ref{sec:G_x,g_x}.
    That coefficient is given by the product $g_{ee}(u)I(u)$.
    UPDATE: apparently the definitions of the $G_x(u)$ functions has changed in the
	documentation (and code?). A diffusion coefficient $d_x$ is now part of
	$G_x(u)$, this did not appear in version 1.0.0 of the manual.
  \item TODO: The choice for the Debye length (without ion shielding) should be
    documented. Are there any scenario's where the expression {\em with} ion
    shielding should be used (even if just for comparison purposes)?
\end{itemize}

\section{Final Form}

\begin{equation}
	\tilde{C}^0(u) = -\sum\limits_{x=el,car,ee}\DERIV{H_x}{u} + \sum\limits_{x=inel,ion,att}\tilde{C}^0_{x}(u)
\end{equation}
and combination with the field term and with a growth term yields
\begin{equation}
	\sum\limits_{x=el,car,ee,E_g}\DERIV{H_x}{u}
	=
	\sum\limits_{x=inel,ion,att}\tilde{C}^0_{x}(u)
	+
	\tilde{R}^0_g(u).
	\label{eq:EBE-final}
\end{equation}
for $g=pt,sst$.
NOTES: here are some good reasons for presenting the equations this way:
\begin{itemize}
	\item The convective and diffusive parts of the functions $H_x(u)$
	can be combined if (e.g.) the exponential scheme is used.
\end{itemize}
BUT: the new `transport terms' are still sources, really. Also the
growth term is a bit confusing the way it is written, since the
$\dd{}/\dd{t}$ terms are normally expected on th LHS.

TODO:
\begin{itemize}
	\item In LoKI-B (MATLAB, original C++), all terms are moved to the
		right-hand side. The matrix that is assembled appears to
		be {\em negative}-semidefinite (before applying the normalization
		constraint to the first row).
		Can that hurt performance of any solver?
\end{itemize}


\chapter{Discretization}

\label{ch:disc}

\section{Discretization of the Equation}

Without making additional assumptions, equation \eqref{eq:EBE-final} can be integrated
over cell $k$ and divided by the energy interval $\Delta u$,
\begin{equation}
	\sum\limits_{x=el,car,ee,E_g}\MEAN{\DERIV{H_x}{u}}_k
	=
	\sum\limits_{x=inel,ion,att}\MEAN{\tilde{C}^0_{x}(u)}_k
	+
	\MEAN{\tilde{R}^0_g(u)}_k.
	\label{eq:EBE-final-avg}
\end{equation}
Of course, the terms now represent their mean values in cell $k$.
The terms on the left-hand side of equation \eqref{eq:EBE-final-avg} can be
rewritten as
\begin{equation}
	\MEAN{\DERIV{H_x}{u}}_k
	= \frac{1}{\Delta u}\int\limits_{\mhalf{k}}^{\phalf{k}}\DERIV{H_x}{u}\dd{u}
	= \frac{H_{x,\phalf{k}}-H_{x,\mhalf{k}}}{\Delta u}.
	\label{eq:mean-dH/du_k}
\end{equation}


This form is used in LoKI-B as starting point for the discretization of the
equation. In this chapter we will discuss the discrete approximations of the
terms that appear in equation \eqref{eq:EBE-final-avg}.

\section{Discretization of the Flux-Divergence Terms}

\label{sec:dH/du-disc}

Most flux functions $H_x(u)$ that appear in LoKI-B are of the advection-diffusion
type and can be written as \cite[below 25a]{Manual_2_2_0}
\begin{equation}
	H_x(u) = -h_x(u)\left[d_xf^0(u) + c_x\DERIV{f^0}{u}\right],
	\label{eq:H_x-expr}
\end{equation}
where the coefficients $c_x$ and $d_x$ are $u$-independent.
Here we have followed the conventions that are used in the LoKI-B manual,
the relation with the functions $G_x$ and $g_x$ that appear in the manual
are $H_x=G_x/N$, $h_x=\gamma g_x$. Also note that the choice for the symbols
$d_x$ and $c_x$ is very unfortunate, since $d_x$ descibes the convective
part, $c_x$ the diffusive part of the flux. The expression for the
electron-electron operator does not fit in this scheme, since the coefficients
$d_x$ and $c_x$ cannot both be made $u$-independent. This way of writing also
makes it difficult to add fluxes. That is: the sum of fluxes of this type
cannot be written in terms of sums of the coefficients $h_x$, $c_x$ and $d_x$.
That also makes it difficult to apply any other scheme than the central
difference one.
\begin{framed}
TODO: for these reasons, reconsider format \eqref{eq:H_x-expr}.
\end{framed}

Using the notation $f_k:=f(u_{k})$, using linear interpolation for the face value of $f^0(u)$ and a central-difference
approximation for its derivative of, the flux on an internal face $\phalf{k}$ is given by
\begin{align}
  H_x(u_{\phalf{k}})
    &\doteq
      - h_x(u_{\phalf{k}})\left(d_x\frac{f_{k+1}+f_k}{2}+c_x\frac{f_{k+1}-f_k}{\Delta u}\right)
\nonumber \\
    &=
        h_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}-\frac{d_x}{2}\right)f_k
      - h_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}+\frac{d_x}{2}\right)f_{k+1}
\nonumber \\
    &:=
        {\cal B}_{x,\phalf{k}}f_k
      - {\cal A}_{x,\phalf{k}}f_{k+1}.
\end{align}
Here we have defined the coefficients ${\cal B}_{\phalf{k}}$ and ${\cal A}_{\phalf{k}}$ that
describe the weights of the cell values behind and ahead of the interface $\phalf{k}$ under study
(see Patankar's seminal work on flux discretisation, \cite[eq. 5.37]{Patankar1980}, although
in that work a {\em normalized} flux is considered). We find that
\begin{align}
    {\cal B}_{x,\phalf{k}} &= h_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}-\frac{d_x}{2}\right), \\
    {\cal A}_{x,\phalf{k}} &= h_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}+\frac{d_x}{2}\right).
\end{align}

The flux $H_x(u_{\mhalf{k}})$ is obtained by the substitution $k\rightarrow k-1$ in the
previous expressions. Substitution of these flux approximations in equation \eqref{eq:mean-dH/du_k} results in
\begin{equation}
  \MEAN{\DERIV{H_x}{u}}_k
       = \frac{1}{\Delta u}\left[-{\cal B}_{x,\mhalf{k}}f_{k-1}
          +\left( {\cal A}_{x,\mhalf{k}} + {\cal B}_{x,\phalf{k}} \right) f_k
          -{\cal A}_{x,\phalf{k}}f_{k+1}
	\right].
	\label{eq:dH/du-k}
\end{equation}
The boundary flux is zero at both ends of the grid. This condition can be incorporated
by setting ${\cal A}_{x}={\cal B}_{x}=0$ for boundary faces and skipping terms in the
equation above that involve a non-existing value $f(u_{-1})$ or $f(u_{\cal N})$.

The resulting coefficients can be stored in the $k$'th row of a discretization matrix $M_x$,
which allows us to write
\begin{equation}
  \MEAN{\DERIV{H_x}{u}}_k \doteq \sum\limits_{l=0}^{\cal N}M_{x,kl}f_l.
	\label{eq:dH/du-discrete}
\end{equation}
Note that the discretization matrix is tridiagonal, it has non-zero elements only for $|k-l|\leq 1$.
\begin{framed}
There is a lot to be said about the coefficients ${\cal A}_{x}$ and ${\cal B}_{x}$.
For example,
\[
	{\cal A}_{x,\pmhalf{k}} = {\cal B}_{x,\pmhalf{k}} + h_x(u_{\pmhalf{k}})d_x.
\]
This is true not only for the central difference scheme, but also for any other,
such as the Scharfetter-Gummel (`exponential') scheme. It is also useful to write
the coefficients as
\begin{align*}
    {\cal B}_{x,\phalf{k}} &= \frac{h_x(u_{\phalf{k}})c_x}{\Delta u}\left(1-\frac{P_{\phalf{k}}}{2}\right), \\
    {\cal A}_{x,\phalf{k}} &= \frac{h_x(u_{\phalf{k}})c_x}{\Delta u}\left(1+\frac{P_{\phalf{k}}}{2}\right),
\end{align*}
where the {\em grid P\'eclet number} $P$ has been introduced,
\begin{equation}
	P_{\phalf{k}} = \frac{d_x\Delta u}{c_x}.
\end{equation}
This notation brings the code closer to the introduction of the exponential scheme,
if that is deemed desirable. (But note that such scheme should applied to the sum of
$H_x$-terms, not to the terms individually.
\end{framed}

\section{Discretisation of the Electron-Electron Operator}

\begin{framed}
The corresponding bits in the manual are \cite[eqn. 38]{Manual_2_2_0}
and \cite[eqn. 39a--b]{Manual_2_2_0}. Establish that relation somewhere:
the differences are in the minus signs, the multiplications/divisions
by $N$ and the division by $\gamma$ in the code.
\end{framed}

The electron-electron operator $\tilde{C}^0_{ee}(u)$ is given by equation
\eqref{eq:Ctilde=-dH/du} and the flux expression \eqref{eq:H_ee}.
The flux on an internal interface $\phalf{n}$ is approximated using a central-difference scheme,
\begin{equation}
	H_{ee}(u_{\phalf{n}})
		=
		- h_{ee}I(u_{\phalf{n}})\frac{f_{n+1}+f_{n}}{2}
		- h_{ee}J(u_{\phalf{n}})\frac{f_{n+1}-f_{n}}{\Delta u}.
\end{equation}
In order to write this in a more convenient form we define \cite[eqn. 39a--b]{Manual_2_2_0}
\begin{align}
	A_n &= h_{ee}\left(-\frac{I(u_{\phalf{n}})}{2\Delta u} + \frac{J(u_{\phalf{n}})}{(\Delta u)^2}\right),
		\label{eq:ee:A} \\
	B_n &= h_{ee}\left(+\frac{I(u_{\mhalf{n}})}{2\Delta u} + \frac{J(u_{\mhalf{n}})}{(\Delta u)^2}\right).
		\label{eq:ee:B}
\end{align}
Then (equation \eqref{eq:ee:Gabove} is obtained by the substitution $n\rightarrow n-1$):
\begin{align}
	H_{ee}(u_{\phalf{n}})\frac{1}{\Delta u}
		&= A_{n  }f_{n  } - B_{n+1}f_{n+1}, \label{eq:ee:Gabove}
	\\
	H_{ee}(u_{\mhalf{n}})\frac{1}{\Delta u}
		&= A_{n-1}f_{n-1} - B_{n  }f_{n  }. \label{eq:ee:Gbelow}
\end{align}
And for the electron-electron operator we find that
\begin{equation}
	\left.\DERIV{H_{ee}(u)}{u}\right|_n \doteq - A_{n-1}f_{n-1} + (A_n+B_n)f_n - B_{n+1}f_{n+1}.
\end{equation}
\begin{framed}
\begin{itemize}
	\item NOTE that the coefficients $A_n$ and $B_n$ have the opposite meaning of
	Patankar's coefficients ${\cal A}_{n+\frachalf}$ and ${\cal B}_{n+\frachalf}$,
	which refer to ahead and behind the face point in question (and have an additional
	division by $\Delta u$). Also the choice
	for the integer (cell) indices is confusing, since $A_n$ and $B_n$ describe
	face properties, not cell properties. It would be interesting to see what the
	equations look like if we would use the more usual `Patankar-style' definitions.
	That will of course affect the relations such as $\bvec{A}=-h_{ee}\bmat{a}\bvec{f}$
	(see below). Nice side-project.
	\item With these sign conventions and definitions, $A_n$ and $B_n$ are positive,
	the diagonal of the discretization matrix is positive, the equation is
	similar to \eqref{eq:dH/du-k}.
\end{itemize}
\end{framed}

Also in the case of the electron-electron operator we impose the boundary condition
that the flux is zero at both ends of the grid. This condition can be incorporated
as follows (see the discussion below \eqref{eq:dH/du-k}):
\begin{itemize}
	\item The flux at the lower boundary is obtained from equation \eqref{eq:ee:Gbelow}
	for $n=0$. In this equation we need to skip the non-existing term $f_{n-1}$ and
	set $B_0=0$.
	\item The flux at the upper boundary is obtained from equation \eqref{eq:ee:Gabove}
	for $n={\cal N}$. In this equation we need to skip the non-existing term $f_{n+1}$ and
	set $A_{{\cal N}-1}=0$.
\end{itemize}

Let us now look at the evaluation of the arrays $A_n$ and $B_n$. Firstly, from the definitions
of $I(u)$ and $J(u)$ we find that
\begin{align}
	I(u_{\phalf{n}})
		&= \int\limits_0^{u_{\phalf{n}}} f(u)\sqrt{u}\dd{u}
		\doteq
		\sum\limits_{i=0}^{n}f(u_i)\sqrt{u_i}\Delta u, \\
	J(u_{\phalf{n}})
		&= \frac{2}{3}\left(
			\int\limits_0^{u_{\phalf{n}}} f(u)u^{3/2}\dd{u}
			+
			u_{\phalf{n}}^{3/2}\int\limits_{u_{\phalf{n}}}^\infty f(u)\dd{u}
		\right)
		\nonumber \\
		&\doteq
		\frac{2}{3}\left(
			\sum\limits_{i=0}^{n}f(u_i)u_i^{3/2}\Delta u
			+
			u_{\phalf{n}}^{3/2}\sum\limits_{n+1}^\infty f(u_i)\Delta u
		\right)
\end{align}
Then the vectors $\bvec{A}$ and $\bvec{B}$ can be written as
\begin{align}
	\bvec{A} &= h_{ee}\bmat{a}\bvec{f}, \label{eq:ee:A=g_eeaf} \\
	\bvec{B} &= h_{ee}\bmat{b}\bvec{f}, \label{eq:ee:B=g_eebf}
\end{align}
where the matrices $\bmat{a}$ and $\bmat{b}$ have typical elements
\begin{align}
	a_{ij} &= \begin{cases}
			-\frac{1}{2}\sqrt{u_j}          + \frac{2}{3}\frac{u_j^{3/2}}{\Delta u}	    & j \leq i \\
			\phantom{\frac{1}{2}\sqrt{u_j}} + \frac{2}{3}\frac{u_{\phalf{i}}^{3/2}}{\Delta u} & j > i
		\end{cases}, \label{eq:ee:a-orig} \\
	b_{ij} &= \begin{cases}
			+\frac{1}{2}\sqrt{u_j}          + \frac{2}{3}\frac{u_j^{3/2}}{\Delta u}	    & j < i \\
			\phantom{\frac{1}{2}\sqrt{u_j}} + \frac{2}{3}\frac{u_{\mhalf{i}}^{3/2}}{\Delta u} & j \geq i
		\end{cases}. \label{eq:ee:b-orig}
\end{align}
Note that we have changed $n,m\rightarrow i,j$, $j\leq i-1\rightarrow j<i$ and $j>i-1\rightarrow j\geq i$
compared to the presentation in the manual for reasons of readability.

Three more modifications are made to this scheme, as suggested by Rockwood
\cite[Appendix B]{Rockwood1973}:
\begin{itemize}
  \item The matrix $\bmat{b}$ is calculated as $\bmat{a}^T$
	(\cite[eq. B8,B9]{Rockwood1973}). This ensures that the power
	that is absorbed by the electrons in electron-electron collisions
	is zero up to the machine accuracy. (Only {\em exchange} of energy
	among the electrons happens in such collisions.)
  \item The last row and first column of $\bmat{a}$ are set to 0. This ensures
	that $A_{{\cal N}-1}=0$ and $B_0=0$ (\cite[eq. B10]{Rockwood1973});
  \item The substitution $a_{ij} = \sqrt{a^{orig}_{ij}a^{orig}_{j-1,i+1}}$ is made
	(\cite[eq. B11,B13]{Rockwood1973}). This ensures that the energy
	source vanishes for a Maxwellian EEDF up to the machine accuracy
	(eliminating discretization errors).
\end{itemize}
These modifications are further discussed in section \ref{sec:Rockwood-mods}.

\begin{framed}
Some comments on the MATLAB code and documentation:
\begin{itemize}
  \item In the MATLAB code, the implementation of the application of the detailed
    balance requirement appears to contain a bug. The elements of the
    matrix $a_{ij}$ are modified, but read from later. It appears to be
    necessary to make a copy of the original matrix, and read the element
    values from that copy. This fix has been implemented in the C++ code
    and is controlled by the macro \SRC{LOKIB_EE_APPLY_DB_FIX}. The value
    is 1 in git, but the old code is still available. Local testing
    shows that (only) after this fix, the flux $G_{ee}(u)$ and corresponding
    source vanishe up to machine accuracy for a Maxwellian EEDF (see file
    \SRC{tests/test_ee.cpp}).
  \item The MATLAB code (\SRC{ElectronKinetics.m} line 1991 has
    comment {\em ``because of power conservation, terms on the last row (cellNumber,:)
    and on the first column (:,1) are zero''}. That comment is misleading.
    this change achieves that the boundary flux is zero instead. Energy (not `power')
    conservation is ensured by the condition $\bmat{b}=\bmat{a}^T$.
  \item In the manual \cite[text below eq 41c]{Manual_2_2_0}, the skipping
    of the terms is formulated as $A_{-1}=B_{\cal N}=0$ (here adjusted
    for C++ 0-based indices), but of course those coefficients do not
    exist in the arrays $\bvec{A}$ and $\bvec{B}$. Setting those elements
    would give a runtime error. The affected terms should simply be skipped
    instead (and are, in the code).
  \item In the MATLAB code, the name \SRC{alpha} is used for the factor
    $(n_e/N)e^2/(8\pi\epsilon_0^2)\ln\Lambda_c$, instead of \SRC{g_ee}
    (see \SRC{Boltzmann.m} line 1385 in version 2.2.0). The same constant appears
    a second time on line 2078, but this time the name \SRC{eeConstant} is used
    instead of \SRC{alpha}.)
    \begin{enumerate}
      \item In the C++ code, the variable \SRC{alpha} has been renamed to \SRC{g_ee}
        so the code matches the documentation (note: $g_{ee}=h_{ee}/\gamma$).
      \item This also avoids confusion with Rockwood's constant $\alpha$,
        see appendix \ref{sec:Rockwood1973Notes}, which is closely related to
        $g_{ee}$, but not identical.
    \end{enumerate}
  \item In the MATLAB code, the argument of the Coulomb logarithm is expanded as
    (NOTE: $T_e$ is in $\si{eV}$ in LoKI-B):
    \begin{equation}
      \Lambda_c
      = 12\pi\lambda_D^3n_e = 12\pi\left(\epsilon_0T_e/(n_ee)\right)^{3/2}n_e
      = 12\pi\left(\epsilon_0 T_e/e\right)^{3/2}n_e^{-1/2}.
    \end{equation}
    In the C++ code, the readability of these expressions has been improved by
    introducing \SRC{lambdaD} as an intermediate variable and using the first
    expression for $\Lambda_c$.
  \item Rockwood uses the symbols $\bmat{A}$ and $\bmat{B}$ for the matrices
	that have been introduced in equations \eqref{eq:ee:a}--\eqref{eq:ee:b},
	and $\bvec{a}$ and $\bvec{b}$ for the vectors that appear in equations
	\eqref{eq:ee:a}--\eqref{eq:ee:b} --- exactly opposite to the notation
	that is used in LoKI-B.
  \item In the manual \cite[eq. 39a,b,f,g]{Tejero2019}, the matrices are
	defined with $g_{ee}$ included (and no multiplication with $g_{ee}$
	happens when $\bvec{A}$ and $\bvec{B}$ are calculated).

	In the MATLAB code (version 2.2.0, \SRC{ElectronKinetics.m} line 1359)
	these matrices also contain a factor $\Delta u$, which is
	removed when the vectors $\bvec{A}$ and $\bvec{B}$ are calculated (line 1388).
	The reason for this is not clear. In the C++ code, the $\Delta u$
	is left to be part of $\bmat{a}$ and $\bmat{b}$ (we implement equations
	\eqref{eq:ee:A=g_eeaf}--\eqref{eq:ee:b}).
  \item The manual should be updated to reflect the reality of the code.
\end{itemize}
\end{framed}


\chapter{Matrices \& Vectors}

\section{Calculating the Maximum Relative Difference of Two Vectors}

During the development of the C++ code, a nasty difference between MATLAB
and C++ was discovered in the handling of NaN (not-a-number values) values,
that are produced by such operations as $0.0/0.0$, $\infty\cdot 0.0$ and
$\infty/\infty$, where $\infty$ indicates the platform's \SRC{inf} value.

When looking for the maximum element of an array, MATLAB skips NaN's and
returns the highest non-NaN element.
\begin{lstlisting}[language=matlab]
>> max(abs([0 0]./[1 0]))
ans =
     0
\end{lstlisting}
On the other hand, C++ with Eigen returns NaN. The last line of the code
below shows the calculation that was previously in the C++ version of LoKI-B,
it prints a NaN:
\begin{lstlisting}[language=matlab]
    #include <eigen3/Eigen/Dense>
    ...
    using Vector = Eigen::VectorXd;
    Vector ev1(2); ev1[0] = 0.; ev1[0] = 0.;
    Vector ev2(2); ev2[0] = 1.; ev2[0] = 0.;
    std::cout << (ev1.array()/ev2.array()).cwiseAbs().maxCoeff() << std::endl;
\end{lstlisting}
For this reason, a member \SRC{maxRelDiff} has been introduced. That avoids
the spurious NaN's by skipping over points for which both values (old and new)
are different. NOTE that this implements the relative {\em difference}, using
the averaged absolute values as reference, rather than the old or new one.

\section{Linear Systems, Matrix Inversion}

Eigen, the various Hessenberg-solvers.

\section{The Smart Grid}

\subsection{Calculation of the Dynamic Range of the EEDF}

The smart grid functionality can be used to let the program adjust the
upper boundary of the energy grid such that the dynamic range of the
EEDF is within a user-specified specific range. The number of decades
that the EEDF drops is given by the expression
\begin{equation}
    N_d = \log_{10} f_{\mbox{max}} - \log_{10} f_{\mbox{min}}.
\end{equation}
LoKI-B assumes that the highest and lowest EEDF values are attained on
the first and last energy grid point, respectively. This is the expression
that is also implemented in the MATLAB version of LoKI-B. In case of
an underflow for high energy values, such that $f_{\mbox{min}}=0$, while
$f_{\mbox{max}}$ is finite, MATLAB produces the value \SRC{Inf}, since
\SRC{log10} is specified to return \SRC{-Inf} for zero-valued arguments\footnote{
See: \url{https://nl.mathworks.com/help/matlab/ref/log10.html}}.
In such case, a test like \SRC{Inf > N_max} will evaluate as \SRC{true}
and this tells LoKI-B to reduce the upper boundary of the energy grid.
Also the C/C++ function \SRC{log10} is specified to return \SRC{-Inf}
for zero-valued arguments.

It is tempting to combine the logarithms in this expression, wich would
result in
\begin{equation}
    N_d= \log_{10} \frac{f_{\mbox{max}}}{f_{\mbox{min}}}.
\end{equation}
It is important to realize that these expressions may give different
results in the case of underflow, when {\em signed} zeros are produced:
the IEE754 floating point standard recognizes \SRC{0.0} and the
signed zero \SRC{-0.0} as separate numbers, although they do compare
equal\footnote{See: \url{https://en.wikipedia.org/wiki/Signed_zero}}.
However, for a positive finite number $f$ we have \SRC{f/(+0.0)=+Inf}
and \SRC{f/(-0.0)=-Inf}, and while \SRC{log10(+Inf)=+Inf}, we have
\SRC{log10(-Inf)=NaN}. This means that for a positive $f_{\mbox{max}}$ we get
\begin{equation}
    \log_{10} f_{\mbox{max}} - \log_{10}(\pm 0.0)
  = \log_{10} f_{\mbox{max}} - (-\SRC{Inf}) = \SRC{+Inf}.
\end{equation}
whereas
\begin{equation}
  \log_{10} (f_{\mbox{max}}/(\pm 0.0)) = \log_{10}(\pm\SRC{Inf}),
\end{equation}
which gives \SRC{NaN} instead of \SRC{Inf} for a signed zero.

In the C++ code we have implemented the function \SRC{calcDecades(v1,v2)}
for this calculation. It has been implemented to return
\SRC{log10(abs(v1/v2))}. Taking the absolute value allows the calculation
to rely on only one calculation of a logithm, while avoiding the problem
that a \SRC{NaN} is produced for signed zeros. It also allows a comparison
of the size of scalars that are both negative or have different signs.
Perhaps most importantly, it centralizes this simply but tricky bit of
code, so it does not have to be repeated three times in the code.

\section{A Bisecting Smart Grid Implementation}

Let $[D_m,D_p]$ denote the user-specified dynamic range of the EEDF,
and $D(u_x)$ be the dynamic range that is realized for an upper
energy that is equal to $u_x$. The `smart grid feature' can be used
to adjust $u_{\mbox{max}}$ such that $D(u_{\mbox{max}})\in[D_m,D_p]$.
The original implementation uses an adjustment with a user-specified
factor, first lowering $u_{\mbox{max}}$ until the lower boundary is
respected, then increasing $u_{\mbox{max}}$ until the upper boundary
is respected. This can be a slow process, and there is no guarantee
that the criteria are actually met after the algorithm is finished:
when the adjustment factor is too high, you may go from too low to
too high in a single step. On the other hand, choosing a small
adjustment factor will result in lots of iterations.

For these reasons, an alternative implementation of the smart grid adjustment
has been implemented in the C++ version of the code. The new algorithm consists
of two parts. Firstly, values $u_m$ and $u_p$ are determined such that
$[D(u_m),D(u_p)]$ has overlap with $[D_m,D_p]$. (The latter interval
may be enclosed entirely by the former, or the overlap may be partial).
Secondly, the interval $[u_m,u_P]$ is bisected until $[D(u_m),D(u_p)]$
is fully within the specified range and the final $u_{\mbox{max}}$ is
chosen from $[u_m,u_P]$. In detail:
\begin{enumerate}
  \item Set $u_m=u_p=u_{\mbox{max}}$, solve the EEDF and calculate $D(u_M)$;
	if that is in the required range, we are ready.
  \item If $D(u_p)$ is below the required range, keep doubling $u_p$,
	setting $u_{\mbox{max}}=u_p$,
	solving the EEDF and calculating $D(u_p)$ unless it is in the
	required range or above. Else:
        If $D(u_m)$ is above the required range, keep halving $u_m$,
	setting $u_{\mbox{max}}=u_m$,
	solving the EEDF and calculating $D(u_m)$ unless it is in the
	required range or below.
  \item Until $D(u_{\mbox{max}})$ is in the specified range,
	set $u_{\mbox{max}}=(u_m+u_p)/2$, solve the EEDF and calculate
	$D(u_{\mbox{max}})$. If $D(u_{\mbox{max}})<D_m$,
	set $u_m=u_{\mbox{max}}$, else if $D(u_{\mbox{max}})>D_p$,
	set $u_p=u_{\mbox{max}}$. (This bisects the interval until
	one of its end points matches the criterium.)
\end{enumerate}
\begin{framed}
At present, the new implementation can be enabled only by
commenting in the macro \SRC{LOKIB_USE_BISECTING_SMART_GRID}
in \SRC{source/ElectronKinetics.cpp} and recompiling. This
must be controllable from the input file instead.
\end{framed}

\chapter{Build System}

\section{cmake}

\section{autotools}

\section{Cross Compilation}

\section{Automated Testing}

Unit tests, checking results with reference data, comparing the MATLAB and C++
versions, comparisons with BOLSIG+ output.

\appendix

\chapter{Notes on Rockwood's 1973 Paper}

\label{sec:Rockwood1973Notes}

\section{Nomenclature, Variables, Relation with LoKI-B}

Rockwood's paper \cite{Rockwood1973} considers a distribution function $n(\epsilon,t)$ which
is defined such that $n(\epsilon,t)\dd{\epsilon}$ is the number of electrons in the energy
interval $\dd{\epsilon}$.
The rate of change of $n$ is given by Rockwood's equation R.1, which can be written as
\begin{equation}
	\PDEV{n}{t} +\sum_x\PDEV{J_x}{\epsilon} = S_r,
	\label{eq:rockwood:dn/dt}
\end{equation}
where each $J_x$ describes a flux in energy space due to mechanism $x$. Rockwood
considers $x=f$ (the electric field) and $x=ee$ (electron-electron collisions).
The source term $S_r$ describes inelastic and superelastic collisions.

The function $n(\epsilon,t)$ can be expressed in terms of a normalized distribution
function $f_\epsilon(\epsilon,t)$ as
\begin{equation}
	n(\epsilon,t) = n_e(t)\sqrt{\epsilon}f_\epsilon(\epsilon,t)
	\label{eq:rockwood:n}
\end{equation}
Substitution in equation \eqref{eq:rockwood:dn/dt}, application of the Leibniz
product rule and division by $n_e$ yields
\begin{equation}
	\sqrt{\epsilon}\PDEV{f_\epsilon}{t}
	+\sqrt{\epsilon}f\frac{1}{n_e}\PDEV{n_e}{t}
	+\sum_x\PDEV{}{\epsilon}\left(\frac{J_x}{n_e}\right) = \frac{S_r}{n_e}.
	\label{eq:rockwood:dn/dt-expanded}
\end{equation}
LoKI-B uses an $\si{eV}$-based representation $f_u(u)$ of the energy $u$ and distribution
function. From $\epsilon = ue$ and $f_\epsilon(\epsilon)\sqrt{\epsilon}\dd{\epsilon}
= f_u(u)\sqrt{u}\dd{u}$, it follows that $f_\epsilon(\epsilon) = f_u(u)e^{-3/2}$.
Substitution of these expressions in equation \eqref{eq:rockwood:dn/dt} and multiplying
the result with $e$ gives
\begin{equation}
	\sqrt{u}\PDEV{f_u}{t}
	+\sqrt{u}f\frac{1}{n_e}\PDEV{n_e}{t}
	+\sum_x\PDEV{}{u}\left(\frac{J_x}{n_e}\right) = e\frac{S_r}{n_e}.
	\label{eq:rockwood:dn/dt-eV}
\end{equation}
Finally, after dividing by $N\gamma$ we get the form that is compatible with
the expressions that can be found in LoKI-B \cite[eq 3a]{Tejero2019},
\cite[eq. 1]{Tejero2021}, \cite[eq. 7a]{Manual_2_2_0},
\begin{equation}
	\frac{1}{N\gamma}\sqrt{u}\PDEV{f_u}{t}
	+\frac{1}{N\gamma}\sqrt{u}f\frac{1}{n_e}\PDEV{n_e}{t}
	+\sum_x\frac{1}{N\gamma}\PDEV{G_x}{u}
	= S,
	\label{eq:rockwood:dn/dt-LoKI}
\end{equation}
with
\begin{align}
	G_x &= \frac{J_x}{n_e}, \label{eq:rockwood:G(J)} \\
	S   &= \frac{e}{n_eN\gamma}S_r. \label{eq:rockwood:S(Sr)}
\end{align}

\section{The Electron-Electron Collision Operator}
\label{sec:Rockwood1973EE}

For electron-electron collisions, the flux in energy space is given by equation
\cite[eq. B5]{Rockwood1973} (here referred to as R.B5),
\begin{equation}
	J_{ee}
	= \alpha\left[P\left(\frac{n}{2\epsilon}-\PDEV{n}{\epsilon}\right) - Qn\right].
	\label{eq:rockwood:J_ee}
\end{equation}
The functions $P(\epsilon,t)$ and $Q(\epsilon,t)$ are defined below eq. R.B5 and read
\begin{align}
  P(\epsilon,t) &= 2\epsilon^{-1/2}\int\limits_0^\epsilon xn(x,t)\dd{x} + 2\epsilon\int\limits_\epsilon^\infty x^{-1/2}n(x,t)\dd{x}, \\
  Q(\epsilon,t) &= 3\epsilon^{-1/2}\int\limits_0^\epsilon  n(x,t)\dd{x}.
\end{align}
The constant $\alpha$ is given below equation R.B1,
\begin{equation}
	\alpha = \frac{2}{3}\pi e_G^4\sqrt{\frac{2}{m_e}}\ln\Lambda_c.
\end{equation}
Here we have added the suffix $G$ to $e$ to emphasize that the charge is expressed in
Gau\ss ian units. A translation to the SI unit system is achieved by the
substitution\footnote{See for example \url{https://en.wikipedia.org/wiki/Gaussian_units}.}
$e_G = e/\sqrt{4\pi\epsilon_0}$, which results in
\begin{equation}
	\alpha
	= \frac{2}{3}\pi \left(\frac{e}{\sqrt{4\pi\epsilon_0}}\right)^4\sqrt{\frac{2}{m_e}}\ln\Lambda_c
	= \frac{1}{24}\frac{e^4}{\pi\epsilon_0^2}\sqrt{\frac{2}{m_e}}\ln\Lambda_c.
\end{equation}
Substitution of \eqref{eq:rockwood:n} in the expressions for $P$, $Q$ gives
\begin{align}
  P(\epsilon,t)
	&= \frac{3n_e}{\sqrt{\epsilon}}\frac{2}{3}\left(\int\limits_0^\epsilon x^{3/2}f_\epsilon(x,t)\dd{x} + \epsilon^{3/2}\int\limits_\epsilon^\infty f_\epsilon(x,t)\dd{x}\right)
	= \frac{3n_e}{\sqrt{\epsilon}}J(\epsilon,t), \\
  Q(\epsilon,t)
	&= \frac{3n_e}{\sqrt{\epsilon}}\int\limits_0^\epsilon  \sqrt{x}f_\epsilon(x,t)\dd{z}
	= \frac{3n_e}{\sqrt{\epsilon}}I(\epsilon,t),
\end{align}
where we have used the definitions of the functions $I$ and $J$ from equations \eqref{eq:I} and \eqref{eq:J}
and the fact that $n/(2\epsilon)-\dd{n}/\dd{\epsilon}=-n_e\sqrt{\epsilon}\dd{f}/\dd{\epsilon}$.
Substitution of these results in equation \eqref{eq:rockwood:J_ee} yields
\begin{equation}
  J_{ee} = -3\alpha n_e^2\left[I(\epsilon)f_\epsilon + J(\epsilon)\PDEV{f_\epsilon}{\epsilon}\right], \\
\end{equation}

The last step is to cater to LoKI's usage of $\si{eV}$ as energy unit. To this end we again
use $\epsilon = u(\epsilon)e$ and $f_\epsilon(\epsilon)\sqrt{\epsilon}\dd{\epsilon}
= f_u(u)\sqrt{u}\dd{u} \implies f_\epsilon(\epsilon) = f_u(u)e^{-3/2}$.
Furthermore, $I(u)=I(\epsilon)$ and $J(u)=J(\epsilon)/e$. Substitution yields the
equations using LoKI-B quantities (in $\si{eV}$),
\begin{equation}
  J_{ee}(u) = -3\alpha_{eV} n_e^2 \left[I(u)f_u + J(u)\PDEV{f_u}{u}\right],
\end{equation}
with the definition (equation \eqref{eq:alpha_eV})
\[
	\alpha_{eV}
	:= e^{-3/2}\alpha
	= \frac{1}{24}\frac{e^2}{\pi\epsilon_0^2}\sqrt{\frac{2e}{m_e}}\ln\Lambda_c
	= \frac{1}{24}\frac{e^2}{\pi\epsilon_0^2}\gamma\ln\Lambda_c.
\]
This constant corresponds to Hagelaar's $a$ \cite[eq. 38]{Hagelaar2005} (the LoKI-B form is
obtained by taking a factor 3 out of the parentheses of that equation). In that paper
on BOLSIG+ \cite[eq. 32-37]{Hagelaar2005}, also the original Rosenbluth form
\cite[eq. B1--3]{Rockwood1973} of the equations is presented (these are not in divergence-flux
form).

Finally, note that substitution of this expression for $J_{ee}(u)$ in expression
\eqref{eq:rockwood:G(J)} gives an expression for $G_{ee}(u)$,
\[
	G_{ee}(u) = -3\alpha_{eV} n_e \left[I(u)f_u + J(u)\PDEV{f_u}{u}\right],
\]
which is the expression that is used in LoKI-B, see equation \eqref{eq:G(u)}.

\section{Coefficient Modifications}
\label{sec:Rockwood-mods}

Theoretical TODO's:
\begin{itemize}
    \item Show that $A$ and $B$ in Rockwood (below his B7) correspond to
	$a_{ij}$ and $b_{ij}$ in LoKI-B. Re-do the derivations, using `our'
	$f^0(u)$ instead of Rockwood's $n(u)$ (which includes $n_e$ and $\sqrt{\epsilon}$
	and uses SI units), and 0-based arrays.
    \item Show that the modifications are valid within the accuracy of
	the discretization and show that it does not change the physics. We
	expect (at least) that any discretization/modification error vanishes
	for ${\cal N}\rightarrow\infty$ for a fixed $u_{\mbox{max}}$ (so
	$\Delta u\downarrow 0$. Note that the number of cells and,
	consequently, the matrices, grow when ${\cal N}$ is increased, so how
	do we test something like $\bmat{b}=\bmat{a}^T$ in such limit? What
	are the relevent error measures?
    \item The requirement of equilibrium for a Maxwellian distribution function
	is ensured by setting $a_{ij}:=\sqrt{a_{ij}a_{j-1,i+1}}$.
	This requirement is discused in appendix B of that paper, starting at
	eq. 11, which says
	\[
		A_{jk}n_jn_k = A_{k-1,j+1}n_{k-1}n_{j+1} = B_{j+1,k-1}n_{k-1}n_{j+1}.
	\]
	(Here $n_j=n_e\sqrt{u_j}f_j$ and the distribution is Maxwellian.)
	Rockwood's explanation is clear (see the discussion leading to eq. B13),
	but he does not state explicitly {\em how} B13 is imposed.
	Of course, Rockwood's B13 has the additional factors involving $\epsilon$
	because the $\sqrt{\epsilon}$ (and $n_e$) are part of the definition of
	his distribution function $n(\epsilon)$. In LoKI-B we will not have these
	factors and just have the requirement $a_{j,k}=a_{k-1,j+1}$
	the distribution function $n_e\sqrt{\epsilon}f(\epsilon)$ instead of $f(u)$.
\end{itemize}

Let's see how similar are $a_{ij}$ and $b_{ji}$.
NOTE: in reality, first the coefficient modifications are done.
How does that affect this discussion?

\begin{alignat}{2}
	a_{ij}
		&= \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			\sqrt{\frac{u_j}{\Delta u}}\left(\frac{u_j}{\Delta u} -\frac{3}{4}\right)    & j \leq i \\
			\left(\frac{u_{\phalf{i}}}{\Delta u}\right)^{3/2} & j > i
		\end{cases}, \\
	b_{ij}
		&= \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			\sqrt{\frac{u_j}{\Delta u}}\left(\frac{u_j}{\Delta u} +\frac{3}{4}\right)    & j < i \\
			\left(\frac{u_{\mhalf{i}}}{\Delta u}\right)^{3/2} & j \geq i
		\end{cases}.
\end{alignat}
Or
\begin{align}
	a_{ij}
		&= \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			\sqrt{j+\frac{1}{2}}\left(j -\frac{1}{4}\right)    & j \leq i \\
			(i+1)^{3/2} & j > i
		\end{cases}, \label{eq:ee:a} \\
	b_{ij}
		&= \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			\sqrt{j+\frac{1}{2}}\left(j +\frac{5}{4}\right)    & j < i \\
			i^{3/2} & j \geq i
		\end{cases}. \label{eq:ee:b}
\end{align}
For the transpose of $\bmat{a}$ we find
\begin{align}
	a_{ji}
		&= \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			(j+1)^{3/2} & j < i \\
			\sqrt{i+\frac{1}{2}}\left(i -\frac{1}{4}\right)    & j \geq i
		\end{cases}, \label{eq:ee:aT} \\
\end{align}


Then we find that
\begin{equation}
  a_{ji}-b_{ij} = \sqrt{\Delta u}\frac{2}{3}\begin{cases}
			(j+1)^{3/2} - \sqrt{j+\frac{1}{2}}\left(j +\frac{5}{4}\right) & j < i \\
			-i^{3/2} + \sqrt{i+\frac{1}{2}}\left(i -\frac{1}{4}\right)    & j \geq i
	\end{cases}
\end{equation}



\section{Transformation of the Electron-Electron Operator}

Another idea...

NOTE: this section is very sketchy and has not yet been checked thoroughly; be aware of mistakes.
TODO: check if it is useful to use the fact that
\begin{equation}
	\int\limits_0^u f(u')(u')^{k+\frachalf}\dd{u'}
	=
	\int\limits_0^\infty f(u')(u')^{k+\frachalf}\dd{u'}
	-
	\int\limits_u^\infty f(u')(u')^{k+\frachalf}\dd{u'}
	=
	<u^k>
	-
	\int\limits_u^\infty f(u')(u')^{k+\frachalf}\dd{u'}
\end{equation}

\subsection{Transforming the high-energy integrals}
When applied to the second term of $J(u)$ this gives
\begin{align}
	J(u)
	&= \frac{2}{3}\left(
		\int\limits_0^u f(u')(u')^{3/2}\dd{u'}
		-
		\int\limits_0^u f(u')u^{3/2}\dd{u'}
		+
		u^{3/2}<1/\sqrt{u}>
	\right)
	\nonumber \\
	&= \frac{2}{3}\left(
		u^{3/2}<1/\sqrt{u}>
		-
		\int\limits_0^u f(u')(u^{3/2}-(u')^{3/2})\dd{u'}.
	\right).
\end{align}
Substitution of the new expression for $J(u)$ in the expressions for $A_n$
and $B_n$ yields an integral that does not cover the entire energy grid,
\begin{align}
	A_n &= -\frac{g_{ee}}{\Delta u}\left(\frac{I(u_{\phalf{n}})}{2} - \frac{J(u_{\phalf{n}})}{\Delta u}\right)
		\nonumber \\
	&= -\frac{g_{ee}}{\Delta u}\left(
		-\frac{2}{3}u_{\phalf{n}}^{3/2}\frac{<1/\sqrt{u}>}{\Delta u} + \int\limits_0^{u_{\phalf{n}}} f(u')\left[\sqrt{u'} + \frac{2}{3\Delta u}(u_{\phalf{n}}^{3/2}-(u')^{3/2})\right]\dd{u'}
		\right),
		\\
	B_n &= +\frac{g_{ee}}{\Delta u}\left(\frac{I(u_{\mhalf{n}})}{2} + \frac{J(u_{\mhalf{n}})}{\Delta u}\right)
		\nonumber \\
	&= -\frac{g_{ee}}{\Delta u}\left(
		+\frac{2}{3}u_{\mhalf{n}}^{3/2}\frac{<1/\sqrt{u}>}{\Delta u} + \int\limits_0^{u_{\mhalf{n}}} f(u')\left[\sqrt{u'} - \frac{2}{3\Delta u}(u_{\mhalf{n}}^{3/2}-(u')^{3/2})\right]\dd{u'}
		\right).
\end{align}

\subsection{Transforming the low-energy integrals}
When applied to the first term of $J(u)$ this gives
\begin{equation}
	J(u)
	= \frac{2}{3}\left(
		<u>
		-
		\int\limits_u^\infty f(u')(u')^{3/2}\dd{u'}
		+
		u^{3/2}\int\limits_u^\infty f(u')\dd{u'}
	\right)
	= \frac{2}{3}\left(
		<u>
		-
		\int\limits_u^\infty f(u')((u')^{3/2}-u^{3/2})\dd{u'}
	\right),
\end{equation}
and note that the mean energy $<u>$ is available at the point of evaluation, where
it is needed to calculate $T_e$, which is needed to calculate the Debye length.

When applied to $I(u)$, the transformation yields
\begin{align}
	I(u) = 1 - \int\limits_u^\infty f(u')\sqrt{u'}\dd{u'}.
\end{align}
Substitution of the new expressions for $I(u)$ and $J(u)$ in the expressions for $A_n$
and $B_n$ yields an integral that does not cover the entire energy grid,
\begin{align}
	A_n &= -\frac{g_{ee}}{\Delta u}\left(\frac{I(u_{\phalf{n}})}{2} - \frac{J(u_{\phalf{n}})}{\Delta u}\right)
		\nonumber \\
	&= -\frac{g_{ee}}{\Delta u}\left(
		\frac{1}{2} - \frac{2}{3}\frac{<u>}{\Delta u}
		+ \frac{1}{\Delta u}\int\limits_{u_{\phalf{n}}}^\infty f(u')\left(-\frac{\sqrt{u'}}{2} + \frac{2}{3\Delta u}((u')^{3/2}-u_{\phalf{n}}^{3/2})\right)\dd{u'}
		\right),
		\\
	B_n &= +\frac{g_{ee}}{\Delta u}\left(\frac{I(u_{\mhalf{n}})}{2} + \frac{J(u_{\mhalf{n}})}{\Delta u}\right)
		\nonumber \\
	&= +\frac{g_{ee}}{\Delta u}\left(
		\frac{1}{2} + \frac{2}{3}\frac{<u>}{\Delta u}
		+ \frac{1}{\Delta u}\int\limits_{u_{\mhalf{n}}}^\infty f(u')\left(-\frac{\sqrt{u'}}{2} - \frac{2}{3\Delta u}((u')^{3/2}-u_{\mhalf{n}}^{3/2})\right)\dd{u'}
		\right).
\end{align}

\chapter{Derivation of the Klein-Rosseland Relation}

\label{app:KleinRosseland}
Derivation of the Klein-Rosseland relation \cite{Klein1921}.

In Local Thermodynamic Equilibrium (LTE)
\begin{itemize}
	\item The backward and forward process rates are equal,
	\begin{align*}
		&n_en_q\sigma_{qp}(u)\sqrt{u}(\sqrt{u}f^0(u))
		=
		n_en_p\sigma_{pq}(u+u_{pq})\sqrt{u+u_{pq}}(\sqrt{u+u_{pq}}f^0(u+u_{pq}))
		\iff \\
		&\sigma_{qp}(u)
		=
		\sigma_{pq}(u+u_{pq})\frac{u+u_{pq}}{u}\frac{n_p}{n_q}\frac{f^0(u+u_{pq})}{f^0(u)}.
	\end{align*}
	\item The EEDF is Maxwelian, $f^0(u)\propto e^{-u/kT}$. Then
	\[
		\sigma_{qp}(u)
		=
		\sigma_{pq}(u+u_{pq})\frac{u+u_{pq}}{u}\frac{n_p}{n_q}e^{-u_{pq}/kT}.
	\]
	\item The densities $n_p$ and $n_q$ are related by the Boltzmann distribution,
	\[
		\frac{n_q}{g_q}=\frac{n_p}{g_p}e^{-u_{pq}/kT},
	\]
	and substitution yields
	\[
		\sigma_{qp}(u)
		=
		\sigma_{pq}(u+u_{pq})\frac{g_p}{g_q}\frac{u+u_{pq}}{u}.
	\]
	Since this result does not depend on the equilibrium state that was
	assumed for the sake of this derivation, it will also be valid under non-LTE conditions.
	This (general) relation is the Klein-Rosseland relation \eqref{eq:KleinRosseland}.
\end{itemize}

\chapter{Derivation of the Ionization Operators}

\label{app:ionization}

This section relies on the following properties of the $\delta$ function
\begin{align}
	\int\limits_{u_1}^{u_2} f(u)\delta(u-u_0)\dd{u} &= \begin{cases}
		f(u_0)	&:\quad u_1<u_0<u_2 \\
			\mbox{undefined}	&:\quad u=u_1 \vee u=u_2 \\
		0	&:\quad \mbox{otherwise}
	\end{cases} \label{eq:delta-integrals}
	\\
	\delta(u-u_0)f(u) &=\delta(u-u_0)f(u_0), \label{eq:del(u-u0)f(u)=del(u-u0)f(u0)}
	\\
	\delta(u/a-u_0) &=|a|\delta(u-au_0). \label{eq:delta-scaling}
\end{align}
In equation \eqref{eq:delta-integrals}, some authors assume {\em half} the boundary
value of $f(u)$ for $u=u_1 \vee u=u_2$. That practice makes sense because
it allows the splitting of an integral that encloses the peak at the peak
location, and the sum of the two resulting integrals will then still give the
correct correct. But this property cannot be relied on.
\begin{framed}
	In the text below we appear to use, a number of times, the assumption that
	\[
		\int\limits_{u_1}^{u_2} f(u)\delta(u-u_1)\dd{u} = f(u_1)
	\]
	(without factor 1/2). In other words: it is assumed that the peak is fully
	enclosed while it is at the boundary. It is almost as if the lower
	boundary is defined as $u_1^-$, which is symbolic notation for the voodoo
	\[
		\int\limits_{u_1^-}^{u_2} f(u)\delta(u-u_1)\dd{u}
		:=
		\lim_{a\downarrow 0}\int\limits_{u_1-a}^{u_2} f(u)\delta(u-u_1)\dd{u}
		=
		\lim_{a\downarrow 0}f(u_1)
		=
		f(u_1).
	\]
	This type of notation is used now in then in signals and systems engineering
	when the (unilateral) Laplace transform is used, see for example the notation
	$0^+$ in \url{https://en.wikipedia.org/wiki/Laplace_transform}.

	Unfortunately, no source is provided for the starting point
	\eqref{eq:Ctilde0-ion}, so I have not (yet) been able to verify
	that equation (or to confirm the details of the integration intervals).
\end{framed}

The starting point is the expression for the source term in terms of the
Single Differential Cross Section (SDCS) $\sigma_{ion,i}^{sec}(u,u')$, which is
stated in \cite[eq. 13b]{Manual_2_2_0}.
Adjusting for the division by $\gamma$ in the definition of LoKI-B's source
terms, that states that
\begin{align}
	\tilde{C}^0_{ion,i}(u)
	&=\gamma\delta_i\left[
		\int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}^{sec}(u',u'-V_{ion,i}-u)f^0(u')\dd{u'}
		\right.
	\nonumber \\
		&+ \left.
		\int\limits_{2u+V_{ion,i}}^{\infty}u'\sigma_{ion,i}^{sec}(u',u)f^0(u')\dd{u'}
		-
		u\sigma_{ion,i}(u)f^0(u)
	\right].
	\label{eq:Ctilde0-ion}
\end{align}

The SDCS has property \cite[eq. 1]{Opal1971}, \cite[eq. 14]{Manual_2_2_0}
\begin{equation}
	\sigma_{ion,i}(u) = \int\limits_0^{(u-V_{ion,i})/2}\sigma_{ion,i}^{sec}(u,u')\dd{u'}.
	\label{eq:sigma_ion(sigma_ion_sdcs)}
\end{equation}
TODO:
\begin{itemize}
	\item No reference is provided for expression \eqref{eq:Ctilde0-ion}.
		Equation 32 of \cite{Holstein1946} may be equivalent. But in what
		paper is the transformation of Holstein's equation to the form that
		appears in LoKI-B first discussed? One paper `inbetween' that
		refers to Holstein is \cite{Yoshida1983}. Also, Holstein uses
		$\lambda_i=1/(\delta_iN\sigma_{ion,i}^{sec}(u',u))$. Who started to use the
		word SDCS and use that instead?
		Investigate...
	\item Discuss properties of the SDCS, for example Opal's expression
		\eqref{eq:sigma_ion(sigma_ion_sdcs)}: the domain
		is halved in view of symmery of $u'$ with respect to $(u-V_{ion,i})/2$.
		UPDATE: this is MUCH better explained in \cite[below eq. 31a]{Holstein1946}.
	\item Show that the integral \eqref{eq:Ctilde0-ion} is `consistent with'
		$\int_0^\infty \tilde{C}^0_{ion,i}(u)\dd{u}=\MEAN{K_{ion}}$.
	\item Sort out the usage of the delta function with peaks on integral boundaries
		in the cases below.
	\item Doublecheck the probable error in BOLSIG+ (equal sharing case), report
		to Gerjan (see below).
\end{itemize}

\section{The (full) SDCS Model}

TODO: discuss

\section{The One-Takes-All Model}

In the one-takes-all model, $\sigma_{ion,i}^{sec}(u_1,u_2)=\sigma_{ion,i}(u_1)\delta(u_2)$
\cite[above eq. 15]{Manual_2_2_0}.
Substitution yields
\begin{align}
	\tilde{C}^0_{ion,i}(u)
	&=\gamma\delta_i\left[
		 \int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}(u')\delta(u'-V_{ion,i}-u)f^0(u')\dd{u'}
		\right.
	\nonumber \\
		&+\left.
		\int\limits_{2u+V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')\delta(u)f^0(u')\dd{u'}
		-
		u\sigma_{ion,i}(u)f^0(u)
	\right].
\end{align}
The peak of the $\delta$ in the first term on the right-hand side is at $u'=u+V_{ion,v}$,
{\em which is exactly on the boundary of the integration domain}. That renders the
integral undefined according to equation \eqref{eq:delta-integrals}. The results in
LoKI-B \cite[eq. 15, 1st term]{Manual_2_2_0} and in BOLSIG+ \cite[eq. 30, 2nd term]{Hagelaar2005}
are obtained by assuming that the peak is fully enclosed in the domain of integration,
which yields
\begin{equation}
	\int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}(u')\delta(u'-V_{ion,i}-u)f^0(u')\dd{u'}
	=
	(u+V_{ion,i})\sigma_{ion,i}(u+V_{ion,i})f^0(u+V_{ion,i}).
\end{equation}
Let us now look at the second term. Here $\delta(u)$ can be taken outside of the integral over
$u'$. The result is a multiplication of that $\delta(u)$ with a function (an integral) that
depends only on $u$ through the lower integral boundary $2u+V_{ion,i}$. Relation
\eqref{eq:del(u-u0)f(u)=del(u-u0)f(u0)} allows us to set $u=0$ there, the result is
\begin{equation}
	\int\limits_{2u+V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')\delta(u)f^0(u')\dd{u'}
	= \delta(u)\int\limits_{V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')f^0(u')\dd{u'}
	= \delta(u)\MEAN{K_{ion,i}},
\end{equation}
where we have introduced $\MEAN{K_{ion,i}}$, the ionization rate coefficient for state $i$,
\[
	\MEAN{K_{ion,i}} = \gamma\int\limits_{V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')f^0(u')\dd{u'}.
\]
Because $\sigma_{ion,i}(u')=0$ for energies $u'$ below the threshold $V_{ion,i}$,
the lower integral boundary can be changed to 0 without affecting the result,
that is what you find in \cite[eq. 30, last term]{Hagelaar2005}.

Combining the terms yields equation \eqref{eq:Ctilde0-ion-onetakesall}
(equation 15 in \cite{Manual_2_2_0}, equation 30 in \cite{Hagelaar2005}):
\[
	\tilde{C}^0_{ion,i}(u)
	=\gamma\delta_i\left[
		(u+V_{ion,i})\sigma_{ion,i}(u+V_{ion,i})f^0(u+V_{ion,i})
		+
		\delta(u)\MEAN{K_{ion,i}}
		-
		u\sigma_{ion,i}(u)f^0(u)
	\right].
\]

\section{The Equal Sharing Model}
In the equal sharing model, $\sigma_{ion,i}^{sec}(u',u)=\sigma_{ion,i}(u')\delta(u-(u'-V_{ion,i})/2)$
\cite[above eq. 16]{Manual_2_2_0}.
Substitution of this expression yields
\begin{align*}
	&\gamma\delta_i
		\int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}(u')\delta(u'-V_{ion,i}-u-(u'-V_{ion,i})/2)f^0(u')\dd{u'}
	\\
	=&\gamma\delta_i
		\int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}(u')\delta(u'/2-V_{ion,i}/2-u)f^0(u')\dd{u'}
\end{align*}
Using relation \eqref{eq:delta-scaling} to transform the argument of the delta function
results in
\begin{align*}
	\ldots =&2\gamma\delta_i
		\int\limits_{u+V_{ion,i}}^{2u+V_{ion,i}}u'\sigma_{ion,i}(u')\delta(u'-V_{ion,i}-2u)f^0(u')\dd{u'}
	\\
	=&2\gamma\delta_i(2u+V_{ion,i})\sigma_{ion,i}(2u+V_{ion,i})f^0(2u+V_{ion,i})
	.
\end{align*}
Again the peak as located at the boundary of the integration domain, {\bf in the last step
we have assumed that it is fully enclosed for no clear reason}. For the second term we find,
along the same lines, the identical result, but also here we rely on the peak being
{\em enclosed} at the boundary,
\begin{align*}
	&\gamma\delta_i
		\int\limits_{2u+V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')\delta(u-(u'-V_{ion,i})/2)f^0(u')\dd{u'}
	\\
	=2&\gamma\delta_i
		\int\limits_{2u+V_{ion,i}}^{\infty}u'\sigma_{ion,i}(u')\delta(2u-u'+V_{ion,i})f^0(u')\dd{u'}
	\\
	=2&\gamma\delta_i
		(2u+V_{ion,i})\sigma_{ion,i}(2u+V_{ion,i})f^0(2u+V_{ion,i}).
\end{align*}
Combining these terms and adding the third yields equation
\eqref{eq:Ctilde0-ion-equalsharing}
(equation 16 in \cite{Manual_2_2_0}),
\[
	\tilde{C}^0_{ion,i}(u)
	=\gamma\delta_i\left[
		4(2u+V_{ion,i})\sigma_{ion,i}(2u+V_{ion,i})f^0(2u+V_{ion,i})
		-
		u\sigma_{ion,i}(u)f^0(u)
	\right].
\]
Integration of this equation over all energies yields the expected result for the
ionisation rate coefficient:
\begin{align}
	\int\limits_0^\infty\tilde{C}^0_{ion,i}(u)
	&=\gamma\delta_i\left[
		4\int\limits_0^\infty(2u+V_{ion,i})\sigma_{ion,i}(2u+V_{ion,i})f^0(2u+V_{ion,i})\dd{u}
		-
		\int\limits_0^\infty u\sigma_{ion,i}(u)f^0(u)\dd{u}
	\right]
	\nonumber\\
	&=\gamma\delta_i\left[
		2\int\limits_{V_{ion,i}}^\infty t\sigma_{ion,i}(t)f^0(t)\dd{(t)}
		-
		\int\limits_0^\infty u\sigma_{ion,i}(u)f^0(u)\dd{u}
	\right]
	\nonumber\\
	&=\delta_i\left[2\MEAN{K_{ion,i}} - \MEAN{K_{ion,i}}\right] = \delta_i\MEAN{K_{ion,i}},
\end{align}
In the first integral we made the substitution $t=2u+V_{ion,i}$, and note that
after the second equal sign the lower boundary of the first integral can be changed
from $V_{ion,i}$ to 0, since $\sigma_{ion,i}(u)=0$ for $u<V_{ion,i}$.
Also note that $\gamma u\sigma(u)f^0(u)=\sigma(u)v(u)\sqrt{u}f^0(u):=K(u)\sqrt{u}f^0(u)$,
with $K(u)$ the energy-dependent rate coefficient. Multiplying that rate coefficient
with $\sqrt{u}f^0(u)$ and integrating over $u$ yields its average value.

\begin{framed}
Note that the expression for the source in the BOLSIG+ paper \cite[eq. 29]{Hagelaar2005}
is different --- it has a factor 2 instead of 4. That appears to be wrong. Note that
the calculation of the ionization rate coefficient would yield zero for that expression,
instead of the expected result.
\end{framed}

\chapter{Old Notes on LoKI-B 1.0.0}

This chapter contains comments on the 1.0.0 version of LoKI-B. Some parts of
this chapter appear to have been merged (not by me) in the LoKI-B manual since
then, in particular the explanation of Rockwood's algorithm as a finite {\em volume}
method. The first half of section \ref{sec:dGdu-disc} can be found in \cite{Manual_2_2_0}
at the end of page 11 end the beginning of page 12, but a few unnecessary steps have
been added. Also the fluxes $G$ are not discussed separately from the discretization
of their derivative $\dd{G}/\dd{u}$, as is done in \ref{sec:dGdu-disc}.
I think the presentation in \ref{ch:disc} is better anyway. The manual also
still erroneously claims that Rockwood uses a finite {\em difference} method. The error
in the CAR implementation has also been fixed in the mean time.  The LoKI-B code and
manual started to use the $\gamma$ constant.  Let's see what material in this chapter
is still useful to keep around. Probably parts of the discussion of the power terms
is still relevent. In version 2.2.0 of the Manual \cite[p. 20]{Manual_2_2_0},
a derivation of the CAR power term discretization is added (compared to version 1.0.0)
that is unnecessarily complex compared to the derivation in \ref{sec:power-terms},
that we discussed before.

\section{The gamma constant}

\label{sec:gamma-constant}

The symbol $\gamma$ (see equation \eqref{eq:gamma}) is used in the code
available as \SRC{SI::gamma} (relative to the \SRC{loki}
namespace). Note that this appears {\em many} times in the code, and
this change has resulted in much better readability.

Note that in LoKI-B documentation the symbol $\gamma_k$ is
defined as the mass ration of the electron and a species $k$
\cite[below eqn. 9d]{Manual_1_0_0},
\begin{equation}
  \gamma_k = m_e/m_k,
\end{equation}
but the presence of the subscript $k$ avoids any confusion with the
constant $\gamma$, which in addition has the \SRC{SI::} prefix.

\section{The functions $G_x(y)$ and $g_x(u)$}
\label{sec:G_x,g_x}

TODO: UPDATE. The definition of $G_x(u)$ has changed between 1.0.0 and
2.2.0: a `convection coefficient' $d_x$ has been added. The choice of these
names is VERY unfortunate, since $c_x$ and $d_x$ refer to diffusion and
convection, respectively.

Many terms on the left-hand side of the 2-term approximation of the Boltzmann
equation are written in terms of energy-derivatives of functions $G_x(u)$, where
$x$ denotes a particular process type.
\begin{itemize}
  \item Expressions for $G_x(u)$ are given in equations 6b-c of the LoKI-B paper
        \cite{Tejero2019} and in equations 9b-c of the manual \cite{Manual_1_0_0};
        those are identical.
  \item In the manual of version 2.2.0, the definition of $G_x(u)$ has changed,
	a convection coefficient $d_x$ has been added.
\end{itemize}
Of course, the Boltzmann equation does not change if each term is divided by the
same non-zero constant value. That does, however, change the meaning/interpretation
of the individual terms and has resulted in conflicting definitions for
auxiliary functions $g_x(u)$.
\begin{itemize}
  \item In the paper \cite[eqn. 15d]{Tejero2019}, $g_x(u)$ and $c_u$ are defined
        by the relation
        \[
          G_x(u) = g_x(u)\left(f(u)+c_x\DERIV{f(u)}{u}\right),
        \]
        of which the energy-derivative is stated in the text. As an example,
        for the elastic operator this results in \cite[eqn. 6b]{Tejero2019},
        \[
           g_{el}(u)=-\sum\limits_k 2\gamma_k\nu^{el}_{k,c}(u)u^{3/2}
           = -N\sqrt{2e/m_e}\;2u^2\sum\limits_k \delta_k\gamma_k\sigma^{el}_{k,c}(u)
           := -N\gamma\;2u^2\sigma^{el}_u(u).
        \]
        (TODO: add note about the 'eneragy averaged cross section here, including $2m_e/m_k$.)
        This matches the {\em comments} in the MATLAB code, which announce
\begin{lstlisting}
  g_c(u) = -N*sqrt(2*e/me)*2*u^2*sigmaC(u);
\end{lstlisting}
  \item In the user manual \cite[eqn. 16d]{Tejero2019}, $g_x(u)$ is defined
        relative to $G_x(u)/(N\gamma)$, that is:
        \begin{equation}
          \frac{1}{N\gamma}G_x(u) = g_x(u)\left(f(u)+c_x\DERIV{f(u)}{u}\right).
          \label{eq:G(g)}
        \end{equation}
        That would instead result in:
\begin{lstlisting}
  g_c(u) = -2*u^2*sigmaC(u);
\end{lstlisting}
  \item In the actual implementation we find the latter definition, but {\em without
        the minus sign}: the implementation of the elastic operator actually does
\begin{lstlisting}
  boltzmann.g_c = 2*boltzmann.energyGrid.node.^2.*boltzmann.elasticCrossSection;
\end{lstlisting}
        So the function $g_x(u)$ that we actually find in the code corresponds to the definition
        \[
          \frac{1}{N\gamma}G_x(u) = -g_x(u)\left(f(u)+c_x\DERIV{f(u)}{u}\right).
        \]
  \item Since the expressions for the discretization coefficients in terms of
        $g_x(u)$ are the same in the code as in the manual, the effect is that
        the matrices $M_x$ that are set up such that
        \[
           [M_{x,ij}][f_j] \doteq -\frac{1}{N\gamma}\DERIV{G_x(u)}{u}.
        \]
        (Also see section \ref{sec:dGdu-disc}.)
  \item Note that the elements of $g_x(u)$ are also used to calculated the
        elastic terms on the power balance, see \cite[eq. 24c]{Tejero2019},
        \cite[eq. 38c]{Manual_1_0_0} and section \ref{sec:power-terms} of the
	present text\footnote{
          In the code, a different expression is used, that appears to be
          based on partial integration of the expressions in the paper and
          manual. See section \ref{sec:power-terms}.}
        When the meaning of $g_x(u)$ is changed, also those expressions must
        be updated accordingly.
  \item In order to compare expressions with those in the BOLSIG+ paper
        \cite{Hagelaar2005}, it is important to realize that in that paper the
        terms of the equation correspond to the LoKI-B expressions
        \[
          \frac{1}{N}\DERIV{G_x(u)}{u},
        \]
        in other words: there is no division by $\gamma$. As an example, consider
        \[
          \frac{1}{N}G_{el}(u)
          = -\gamma\;2u^2\sigma^{el}_u(u)\left[f(u) + \frac{k_BT}{e}\DERIV{f(u)}{u}\right].
        \]
        This corresponds to the elastic part (involving $\sigma_\epsilon$) of equations
        40 and 41 of \cite{Hagelaar2005}.
        TODO: note the definition of $\sigma_\epsilon$ in equation (42) in
        \cite{Hagelaar2005}. The correspondence with the expression in LoKI-B should
        be made explicit, the mass-ratios emphasized.
\end{itemize}

\section{The CAR Implementation}

The CAR term in the EBE is described by equation 6c of \cite{Tejero2019}.
It can be written in the form \eqref{eq:G(g)}, with
\begin{align}
  N\gamma g_{CAR} &= -\sum\limits_k 4B_k\nu_{0,k}\sqrt{u}, \\
  c_{CAR} &= k_BT_e/e.
\end{align}
The frequency of the CAR cross section for a gas $k$ is presented just below
equation 6d of \cite{Tejero2019}. Using the definition of the gas fraction
$\chi_k$ from equation \eqref{eq:gamma} this becomes
\begin{equation}
  \nu_{0,k} = N_k\sqrt{2eu/m_e}\sigma_{0,k} = N\gamma\sqrt{u}\chi_k\sigma_{0,k}
\end{equation}
and substitution in the expression for $g_{CAR}$ yields
\begin{equation}
  g_{CAR} = -4u\sum\limits_k \chi_k\sigma_{0,k}B_k.
  \label{eq:g_CAR}
\end{equation}
\begin{framed}
  As discussed elsewhere, in the code we find $g_{CAR}$ defined without
  the minus sign --- the same is true for other $g_x(u)$.
\end{framed}

The CAR cross section for a gas $k$ can be found in the LoKI-B paper \cite{Tejero2019}
in the text below equation 6d, which states
\begin{equation}
  \sigma_{0,k} = \frac{8\pi}{15}Q_{k,au}^2a_0^2,
  \label{eq:sigma_CAR}
\end{equation}
where $a_0$ is the Bohr radius and $Q_{k,au}$ is the quadrupole moment of that
gas {\em in atomic units} ($ea_0^2$).
This expression is also found in the user manual \cite{Manual_1_0_0} (below
equation 9d) and in the paper of Ridenti \etal \cite{Ridenti2015} (below
equation 8b). Those sources refer to the paper of Gerjuoy and Stein
\cite{Gerjuoy1955}, where this term appears as a factor in equation 20.
To emphasize that $Q_{k,au}$ is a dimensionless number (the numerical value
that arises when atomic units are used), we have added the suffix $au$ in equation
\eqref{eq:sigma_CAR}; this does not appear in the sources cited above.

Substitution of this expression in \eqref{eq:g_CAR} gives
\begin{equation}
  g_{CAR} = -4u\frac{8\pi}{15}a_0^2\sum\limits_k \chi_k Q_{k,au}^2B_k.
\end{equation}

\begin{framed}
Note (December 14 2020) ---
In version 1.0.0 of the LoKI-B code (MATLAB), $\sigma_{0,k} = \frac{8\pi}{15}Q_{k,au}a_0^2$,
was used (without the square on $Q_{k,au}$). Since $Q_{k,au}=Q_k/(ea_0^2)$, where
$Q_k$ is the value in SI units, that would result in $\sigma_{0,k}=(8\pi/15)Q_k/e$
and in
\begin{equation}
  \sum\limits_k\chi_k\sigma_{0,k}B_k = \frac{8\pi}{15}\frac{1}{e}\sum\limits_k \chi_k Q_kB_k,
\end{equation}
and this is what was found in the code in \SRC{Boltzmann.m} line 423,
in function \SRC{evaluateCAROperator}:
\begin{lstlisting}[language=matlab]
sigma0B = 0;
for gasName = boltzmann.CARgases
  gasID = Gas.find(gasName, boltzmann.gasArray);
  gas = boltzmann.gasArray(gasID);
  sigma0B = sigma0B + gas.fraction*gas.electricQuadrupoleMoment*gas.rotationalConstant;
end
sigma0B = 8.0*pi*sigma0B/(15.0*Constant.electronCharge);
\end{lstlisting}
(Note that in the MATLAB code indeed \SRC{electricQuadrupoleMoment} is expressed
in SI units, see file \SRC{input/Databases/quadrupoleMoment.txt}.)

Since $Q_{k,au}$ is usually of order unity, it is no surprise
that this could go unnoticed. The implementation has been corrected to
\begin{lstlisting}[language=matlab]
a02 = Constant.bohrRadius*Constant.bohrRadius:
sigma0B = 0;
for gasName = boltzmann.CARgases
  gasID = Gas.find(gasName, boltzmann.gasArray);
  gas = boltzmann.gasArray(gasID);
  Qau = gas.electricQuadrupoleMoment/(Constant.electronCharge*a02);
  sigma0B = sigma0B + gas.fraction*Qau*Qau*gas.rotationalConstant;
end
sigma0B = (8.0*pi*a02/15.0)*sigma0B;
\end{lstlisting}
Previous versions of the C++ implementation had the same problem, it
has been fixed along the same lines.

\end{framed}

\section{Final form of the equation}
In \cite[eqn. 3a]{Tejero2019} the final form of the two-term approximation of the
Boltzmann equation with a temporal growth term is written as
\begin{equation}
  \frac{1}{N\gamma}\MEAN{\nu_{\mbox{eff}}}uf(u) + \frac{1}{N\gamma}\DERIV{G(u)}{u} = S(u).
\end{equation}
The equation with the spatial growth model is similar, only the first term takes
a different form. The equation is subject to the normalization condition
\begin{equation}
  \int\limits_0^\infty \sqrt{u}f(u)du=1.
  \label{eq:f-norm}
\end{equation}
Bringing all terms of the EBE to the right-hand side of the equation yields
\begin{equation}
  -\frac{1}{N\gamma}\MEAN{\nu_{\mbox{eff}}}uf(u) - \frac{1}{N\gamma}\DERIV{G(u)}{u} + S(u) = 0.
  \label{eq:EBE-temp}
\end{equation}
In LoKI-B, this particular form of the equation is cast in matrix-vector form,
\begin{equation}
  \sum\limits_{j=0}^{N_c-1}C_{ij}f_j = 0.
  \label{eq:Cf=0}
\end{equation}
In this equation, the system matrix $C_{ij}=\sum_x C_{x,ij}$, where each
matrix $C_{x,ij}$ corresponds to one of a terms, identified by $x$, in
equation \eqref{eq:EBE-temp}. Then, for example
\[
   \sum\limits_{j=0}^{N_c-1}C_{el,ij}f_j
   \doteq
   -\frac{1}{N\gamma}\left.\DERIV{G_{el}(u)}{u}\right|_{u_i}.
\]
Note that a constant multiplication factor could still be applied to the matrix
$C_{ij}$ in equation \eqref{eq:Cf=0} without changing the solution, but that
would change the physical meaning of an expression like $\sum_jC_{el,ij}f_j$.
Note that for some terms the coefficients depend on $f$, making this a
{\em non-linear system}.

TODO: verify that the above is indeed what is done by LoKI-B (and be very precise).

Since the system is homogeneous, the solution is determined up to a constant
multiplication factor. This follows from the normalization condition
\eqref{eq:f-norm}, which can be approximated as
\begin{equation}
  \sum\limits_{j=0}^{N_c-1} \sqrt{u_j} f_j \Delta u = 1.
  \label{eq:f-norm-disc}
\end{equation}
This condition can be imposed ion the system in multiple ways:
\begin{itemize}
  \item Replace equation \eqref{eq:Cf=0} with the discrete form of the
    normalization condition as given by \eqref{eq:f-norm-disc}.
  \item Replace this equation with the equation $f_0=1$ (or another fixed
    number), solve the system and scale the solution afterwards.
\end{itemize}
It appears that at present both are done (in both MATLAB and C++ versions). The
advantage of (only) using the second mathod is that no unnecessary non-zero
entries are introduced in the system matrix. This is beneficial when a sparse
matrix solver is adopted. Especially when a band matrix format is used, it
prevents all upper diagonals to be allocated, in many cases only containing
a single non-zero element in the first row due to the normalization condition.

\section{Discretization of the Energy Transport Terms}
\label{sec:dGdu-disc}

The LoKI-B paper \cite{Tejero2019} discusses the numerical recipes in
section 3.4. There it is stated that the finite-difference method of
Rockwood \cite[appendix A]{Rockwood1973} is used. The relation between Rockwood's
discretization strategy and the one adopted in LoKI-B is not immediately
clear, since Rockwood provides explicit expression for the two terms
he considers (field and elastic terms), not the general recipe.

Rockwood approximates $\dd{G(u)}/\dd{u}$ in the cell points $k$ as
\begin{equation}
  \left.\DERIV{G_x(u)}{u}\right|_k
  = \frac{G_x(u_{\phalf{k}}) - G_x(u_{\mhalf{k}})}{\Delta u}.
\end{equation}
It is important to realize that this amounts to a finite-{\em volume} method,
since the right-hand side can also be written as
\[
  \frac{1}{\Delta u}\left[G_x(u_{\phalf{k}}) - G_x(u_{\mhalf{k}})\right]
  =
  \frac{1}{\Delta u}\int\limits_{u_{\mhalf{k}}}^{u_{\phalf{k}}}\DERIV{G_x(u)}{u}\dd{u},
\]
which makes clear that the approximation amounts to replacing the value of
$\dd G_x/\dd u$ with its mean value in the interval
$[u_{\mhalf{k}},u_{\phalf{k}}]$. Except for the factor $1/\Delta u$ this is,
of course, the volume integral of $\dd G_x(u)/\dd u$ over that interval.
All this can be recognized as applying Gau\ss' theorem to an integral over
a one-dimensional energy volume, with flux $G(u)$ and flux-divergence
$\dd G(u)/\dd u$.

This analysis makes clear that the emphasis can be placed on a proper discretization
of the flux $G(u)$ on the boundaries $u_{\mhalf{k}}$ and $u_{\phalf{k}}$ of the cell
around $u_k$. LoKI-B follows Rockwood in adopting a central difference scheme for
the approximation of equation \eqref{eq:G(g)}. Using the definition of $G_x(u)$
that appears in the user manual, see equation \ref{eq:G(g)} of the present text,
we get
\begin{align}
  \frac{1}{N\gamma}G_x(u_{\phalf{k}})
    &\doteq g_x(u_{\phalf{k}})\left(\frac{f(u_{k+1})+f(u_k)}{2}+c_x\frac{f(u_{k+1})-f(u_k)}{\Delta u}\right) \nonumber \\
    &\doteq
      -g_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right)f(u_k)
      +
      g_x(u_{\phalf{k}})\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)f(u_{k+1})
  \\
  \frac{1}{N\gamma}G_x(u_{\mhalf{k}})
    &\doteq g_x(u_{\mhalf{k}})\left(\frac{f(u_{k})+f(u_{k-1})}{2}+c_x\frac{f(u_{k})-f(u_{k-1})}{\Delta u}\right) \nonumber \\
    &\doteq
      g_x(u_{\mhalf{k}})\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)f(u_k)
      -
      g_x(u_{\mhalf{k}})\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right)f(u_{k-1})
\end{align}
Which results in the following discrete result,
\begin{align}
  \frac{1}{N\gamma}\DERIV{G_x(u)}{u}
  \doteq& \frac{1}{N\gamma}\frac{G_x(u_{\phalf{k}}) - G_x(u_{\mhalf{k}})}{\Delta u} \nonumber \\
       =& +\left[\frac{g_x(u_{\mhalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right)\right]f(u_{k-1}) \nonumber \\
        & -\left[
              \frac{g_x(u_{\mhalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)
            + \frac{g_x(u_{\phalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right)
           \right] f(u_k) \nonumber \\
        & +\left[\frac{g_x(u_{\phalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)\right]f(u_{k+1}) \nonumber \\
       =& M_x(k,k-1)f(u_{k-1}) + M_x(k,k)f(u_k) + M_x(k,k+1)f(u_{k+1}).
	\label{eq:-dGdu/Ngamma-discrete}
\end{align}
NOTE: A relation between the central coefficient $M_x(k,k)$ and the neighbour
coefficients can be derived as follows:
\begin{align}
  -M_x(k,k)
    &=
    \frac{g_x(u_{\mhalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)
    +
    \frac{g_x(u_{\phalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right) \nonumber \\
    &=
    \frac{g_x(u_{\mhalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}-\frac{1}{2}\right)
    +
    \frac{g_x(u_{\phalf{k}})}{\Delta u}\left(\frac{c_x}{\Delta u}+\frac{1}{2}\right)
    + \frac{g_x(u_{\mhalf{k}})}{\Delta u} - \frac{g_x(u_{\phalf{k}})}{\Delta u} \nonumber \\
    &=
    M_x(k,k-1)
    +
    M_x(k,k+1)
    + \frac{g_x(u_{\mhalf{k}}) - g_x(u_{\phalf{k}})}{\Delta u}.
\end{align}
this can be used later on to do some stability analysis on the scheme. In brief:
consider a situation where this is the only term in the Boltzmann equation, and
assume that $g_x(u_{\mhalf{k}})=g_x(u_{\phalf{k}})$ for some cell $k$. Then we can
derive
\begin{align}
  &M_x(k,k-1)f(u_{k-1}) + M_x(k,k)f(u_k) + M_x(k,k+1)f(u_{k+1}) = 0 \nonumber \\
  \implies & M_x(k,k)f(u_k) = - M_x(k,k+1)f(u_{k+1}) - M_x(k,k-1)f(u_{k-1}) \nonumber \\
  \implies & (M_x(k,k-1)+M_x(k,k+1))f(u_k) = + M_x(k,k+1)f(u_{k+1}) + M_x(k,k-1)f(u_{k-1}) \nonumber \\
  \implies & f(u_k) = (1-\alpha)f(u_{k+1}) + \alpha f(u_{k-1}),
\end{align}
where $\alpha=M_x(k,k-1)/(M_x(k,k-1)+M_x(k,k+1))$. Only if the coefficients $M_x(k,k-1)$
and $M_x(k,k+1)$ have the same sign will this result in monotonic behaviour of the solution
$f(u)$. From this we can deduce the requirement that $||c_x/\Delta u||>1/2$, or
$||\Delta u/c_x||<2$. This number can be recognized as the {\em grid P\'eclet number}
of the problem. The condition can be eliminated by using another scheme than the
central difference scheme (upwind, Scharfetter-Gummel, ...).

Note that a true finite-difference scheme (not in LoKI-B) would have been obtained by
first employing the product rule for differentiation and grouping terms with the
same derivative of $f(u)$,
\begin{equation}
  \frac{1}{N\gamma}G_x(u)
    = \DERIV{g_x(u)}{u}f(u)
    + \left(g_x(u)+\DERIV{g_x(u)}{u}c_x\right)\DERIV{f(u)}{u}
    + g_x(u)c_x\DDERIV{f(u)}{u},
\end{equation}
then use $f'(u_k)\doteq(f(u_{k+1})-f(u_{k-1}))/(2\Delta u)$ and
$f''(u_k)\doteq(f(u_{k+1})+f(u_{k-1})-2f(u_k))/(\Delta u)^2$, etc.

\section{Power Terms}
\label{sec:power-terms}

\begin{equation}
	\Theta_x
		= -\int\limits_0^\infty u\DERIV{H_x}{u}\dd{u}
		= -\left.uH_x(u)\right|_0^\infty + \int\limits_0^\infty H_x(u)\dd{u}
		=   \int\limits_0^\infty H_x(u)\dd{u}.
\end{equation}
Using expression \eqref{eq:H_x-expr} for $H_x(u)$ gives
\begin{equation}
	\Theta_x
	= -\int\limits_0^\infty h_x(u)d_xf^0(u)\dd{u} - \int\limits_0^\infty h_x(u)c_x\DERIV{f^0}{u}\dd{u}
	:= \Theta_x^{loss} + \Theta_x^{gain}.
\end{equation}

Older text about 1.0.0 follows (updated to include $d_x$ in $G_x(u)$) ...

In the code some integrals appear in a form that differs from that in the LoKI-B
paper and manual. As an example, consider the energy gain and loss terms for CAR
gases (see \cite[eqn 24a--h]{Tejero2019} and \cite[eqn 28a--h]{Manual_1_0_0}),
\begin{align}
	\frac{\Theta^{gain}_{x=el,CAR}}{N} &= -\int\limits_0^\infty g_x(u)c_x\DERIV{f(u)}{u}\dd{u},
	\\
	\frac{\Theta^{loss}_{x=el,CAR}}{N} &= -\int\limits_0^\infty g_x(u)d_xf(u)\dd{u}.
\end{align}
Partial integration of the expression for the gain yields
\begin{equation}
	\frac{\Theta^{gain}_{x=el,CAR}}{N}
	=
	-\left.g_x(u)f(u)\right|_0^\infty
	+\int\limits_0^\infty \DERIV{g_x(u)}{u}c_xf(u)\dd{u}
	=
	\int\limits_0^\infty \DERIV{g_x(u)}{u}c_xf(u)\dd{u},
\end{equation}
where the fact that $g_x(u)$ vanishes for $u=0$ and the product $g_x(u)f(u)$ vanishes
for $u\rightarrow\infty$. The resulting term can be approximated as
\begin{equation}
	\frac{\Theta^{gain}_{x=el,CAR}}{N}
	\doteq
	\sum_{i=0}^{N_c-1} \frac{g_x(u_{i+1/2})-g_x(u_{i-1/2})}{\Delta u}c_xf(u_i)\Delta{u}
	=
	\sum_{i=0}^{N_c-1} \left[g_x(u_{i+1/2})-g_x(u_{i-1/2})\right]c_xf(u_i).
\end{equation}
The loss term can be approximated as
\begin{equation}
	\frac{\Theta^{loss}_{x=el,CAR}}{N}
	\doteq
	\sum_{i=0}^{N_c-1} \frac{g_x(u_{i+1/2})+g_x(u_{i-1/2})}{2}d_xf(u_i)\Delta{u}
	=
	\sum_{i=0}^{N_c-1} \left[g_x(u_{i+1/2})+g_x(u_{i-1/2})\right]d_x\frac{\Delta u}{2}f(u_i).
\end{equation}
The net power is obtained by adding the gain and loss terms and results in
the approximation
\begin{equation}
	\frac{\Theta^{gain}_{x=el,CAR}}{N}
	\doteq
	\sum_{i=0}^{N_c-1} \left[\left(c_x+d_x\frac{\Delta u}{2}\right)g_x(u_{i+1/2})-\left(c_x-d_x\frac{\Delta u}{2}\right)g_x(u_{i-1/2})\right]f(u_i).
\end{equation}
These approximate expressions for the gain and net power have been implemented in
the code, except that in the code also an additional factor $\gamma$ appears (see
sections \eqref{sec:G_x,g_x} and \eqref{sec:gamma-constant}).
In the code the parenthesized coefficients are called \SRC{auxHigh} and \SRC{auxLow}.



\bibliography{../../doc/reflist}

\end{document}
